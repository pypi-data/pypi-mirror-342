<div class="expandable-panel-widget" id="{{ id|default('expandable-panel') }}">
    <div class="panel-header" data-target="{{ id|default('expandable-panel') }}-content">
        <div class="panel-title">{{ title }}</div>
        <div class="panel-toggle">
            <span class="toggle-icon">{% if collapsed %}▼{% else %}▲{% endif %}</span>
        </div>
    </div>
    
    <div class="panel-content" id="{{ id|default('expandable-panel') }}-content" {% if collapsed %}style="display: none;"{% endif %}>
        {% if description %}
        <div class="panel-description">
            {{ description }}
        </div>
        {% endif %}
        
        <div class="panel-body">
            {% block panel_content %}
            <!-- This block can be overridden to provide custom panel content -->
            {% endblock %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initExpandablePanels();
    });

    function initExpandablePanels() {
        document.querySelectorAll('.expandable-panel-widget').forEach(panel => {
            const panelHeader = panel.querySelector('.panel-header');
            if (!panelHeader) return;
            
            const targetId = panelHeader.getAttribute('data-target');
            const panelContent = document.getElementById(targetId);
            const toggleIcon = panelHeader.querySelector('.toggle-icon');
            
            if (!panelContent || !toggleIcon) return;
            
            // Toggle panel visibility when header is clicked
            panelHeader.addEventListener('click', function() {
                // Toggle display
                if (panelContent.style.display === 'none') {
                    expandPanel(panelContent, toggleIcon);
                } else {
                    collapsePanel(panelContent, toggleIcon);
                }
                
                // Dispatch panel state change event
                window.dispatchEvent(new CustomEvent('panelStateChange', {
                    detail: {
                        panelId: panel.id,
                        isExpanded: panelContent.style.display !== 'none'
                    }
                }));
            });
        });
    }
    
    function expandPanel(panelContent, toggleIcon) {
        // First set display to block but keep height at 0
        panelContent.style.display = 'block';
        panelContent.style.height = '0';
        panelContent.style.overflow = 'hidden';
        
        // Get the full height
        const height = panelContent.scrollHeight;
        
        // Set up transition
        panelContent.style.transition = 'height 0.3s ease-out';
        
        // Trigger animation
        setTimeout(function() {
            panelContent.style.height = height + 'px';
            
            // After animation completes, reset height to auto
            setTimeout(function() {
                panelContent.style.height = 'auto';
                panelContent.style.overflow = '';
                panelContent.style.transition = '';
            }, 300);
        }, 10);
        
        // Update toggle icon
        toggleIcon.textContent = '▲';
    }
    
    function collapsePanel(panelContent, toggleIcon) {
        // Get current height
        const height = panelContent.scrollHeight;
        
        // Set fixed height and prepare for animation
        panelContent.style.height = height + 'px';
        panelContent.style.overflow = 'hidden';
        panelContent.style.transition = 'height 0.3s ease-out';
        
        // Trigger animation
        setTimeout(function() {
            panelContent.style.height = '0';
            
            // After animation completes, set display to none
            setTimeout(function() {
                panelContent.style.display = 'none';
                panelContent.style.height = '';
                panelContent.style.overflow = '';
                panelContent.style.transition = '';
            }, 300);
        }, 10);
        
        // Update toggle icon
        toggleIcon.textContent = '▼';
    }
</script>