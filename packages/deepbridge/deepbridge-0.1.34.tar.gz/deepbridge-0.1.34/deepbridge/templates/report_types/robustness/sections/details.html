<!-- details.html -->
<div class="details-section">
    <div class="card">
        <h2>Performance Details</h2>
        <p>Detailed performance metrics for different perturbation levels.</p>
        
        <div class="metrics-details-container">
            <div id="metrics-details-plot" class="chart-plot"></div>
        </div>
        
        <div class="details-data-container">
            <h3>Robustness Metrics</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Robustness Score</td>
                        <td id="robustness-score-value">{{ robustness_score|round(2) }}</td>
                        <td>Overall robustness of the model (higher is better)</td>
                    </tr>
                    <tr>
                        <td>Base Score</td>
                        <td id="base-score-value">{{ base_score|round(3) }}</td>
                        <td>Performance on unperturbed data</td>
                    </tr>
                    <tr>
                        <td>Raw Impact</td>
                        <td id="raw-impact-value">{{ (raw_impact * 100)|round(2) }}%</td>
                        <td>Average performance impact from raw perturbations</td>
                    </tr>
                    <tr>
                        <td>Quantile Impact</td>
                        <td id="quantile-impact-value">{{ (quantile_impact * 100)|round(2) }}%</td>
                        <td>Average performance impact from quantile perturbations</td>
                    </tr>
                    <tr>
                        <td>Metric</td>
                        <td id="metric-value">{{ metric }}</td>
                        <td>Performance metric used for evaluation</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="performance-breakdown">
            <h3>Performance by Perturbation Level</h3>
            <div id="performance-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Perturbation Level</th>
                            <th>Performance</th>
                            <th>Impact %</th>
                            <th>Iterations</th>
                        </tr>
                    </thead>
                    <tbody id="performance-details-data">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize detailed metrics when this tab is shown
    document.addEventListener('DOMContentLoaded', function() {
        // Add a listener for the details tab button
        const detailsTabBtn = document.querySelector('.tab-btn[data-tab="details"]');
        if (detailsTabBtn) {
            detailsTabBtn.addEventListener('click', function() {
                console.log("Details tab clicked, initializing details data");
                initializeDetailsView();
            });
        }
        
        function initializeDetailsView() {
            // Create the metrics chart
            if (typeof Plotly !== 'undefined') {
                createMetricsDetailsChart();
                populatePerformanceTable();
            } else {
                console.error("Plotly is not available for details charts");
                const chartElement = document.getElementById('metrics-details-plot');
                if (chartElement) {
                    chartElement.innerHTML = "<div style='padding: 20px; text-align: center; color: red;'>Plotly library not loaded. Charts cannot be displayed.</div>";
                }
            }
        }
        
        function createMetricsDetailsChart() {
            const chartElement = document.getElementById('metrics-details-plot');
            if (!chartElement) return;
            
            try {
                // Get data from reportData
                let metrics = [];
                let values = [];
                
                // Extract metrics data
                if (window.reportConfig) {
                    // Add main metrics
                    metrics.push('Robustness Score');
                    values.push(window.reportConfig.robustnessScore || 0);
                    
                    // Add impact metrics
                    metrics.push('Raw Impact');
                    values.push(window.reportConfig.rawImpact || 0);
                    
                    metrics.push('Quantile Impact');
                    values.push(window.reportConfig.quantileImpact || 0);
                } else {
                    // No data available
                    console.warn("No metrics data available for chart");
                    chartElement.innerHTML = "<div style='padding: 20px; text-align: center;'>No metrics data available</div>";
                    return;
                }
                
                // Create bar chart
                const trace = {
                    x: metrics,
                    y: values,
                    type: 'bar',
                    marker: {
                        color: ['#27ae60', '#e74c3c', '#f39c12']
                    }
                };
                
                const layout = {
                    title: 'Robustness Metrics Summary',
                    yaxis: {
                        title: 'Value'
                    },
                    margin: {
                        l: 50,
                        r: 50,
                        b: 100,
                        t: 50,
                        pad: 4
                    }
                };
                
                Plotly.newPlot(chartElement, [trace], layout, {responsive: true});
                
            } catch (error) {
                console.error("Error creating metrics details chart:", error);
                chartElement.innerHTML = `<div style='padding: 20px; color: red;'>Error creating chart: ${error.message}</div>`;
            }
        }
        
        function populatePerformanceTable() {
            const tableBody = document.getElementById('performance-details-data');
            if (!tableBody) return;
            
            try {
                // Clear existing rows
                tableBody.innerHTML = '';
                
                if (window.reportData && window.reportData.raw && window.reportData.raw.by_level) {
                    const rawData = window.reportData.raw.by_level;
                    const levels = Object.keys(rawData).sort((a, b) => parseFloat(a) - parseFloat(b));
                    
                    levels.forEach(level => {
                        if (rawData[level] && rawData[level].overall_result) {
                            const result = rawData[level].overall_result;
                            let levelData;
                            
                            if (result.all_features) {
                                levelData = result.all_features;
                            } else if (result.feature_subset) {
                                levelData = result.feature_subset;
                            } else {
                                return; // Skip if no data
                            }
                            
                            const row = document.createElement('tr');
                            
                            // Level
                            const levelCell = document.createElement('td');
                            levelCell.textContent = level;
                            row.appendChild(levelCell);
                            
                            // Performance
                            const performanceCell = document.createElement('td');
                            performanceCell.textContent = levelData.mean_score ? levelData.mean_score.toFixed(3) : 'N/A';
                            row.appendChild(performanceCell);
                            
                            // Impact %
                            const impactCell = document.createElement('td');
                            impactCell.textContent = levelData.impact ? (levelData.impact * 100).toFixed(2) + '%' : 'N/A';
                            row.appendChild(impactCell);
                            
                            // Iterations
                            const iterationsCell = document.createElement('td');
                            if (levelData.iterations && levelData.iterations.n_iterations) {
                                iterationsCell.textContent = levelData.iterations.n_iterations;
                            } else {
                                iterationsCell.textContent = window.reportData.iterations || 'N/A';
                            }
                            row.appendChild(iterationsCell);
                            
                            tableBody.appendChild(row);
                        }
                    });
                } else {
                    // Add a message if no data found
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 4;
                    cell.textContent = 'No perturbation data available';
                    cell.style.textAlign = 'center';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                }
            } catch (error) {
                console.error("Error populating performance table:", error);
                
                // Show error message
                tableBody.innerHTML = '';
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 4;
                cell.textContent = 'Error loading performance data';
                cell.style.textAlign = 'center';
                cell.style.color = 'red';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        }
    });
</script>
