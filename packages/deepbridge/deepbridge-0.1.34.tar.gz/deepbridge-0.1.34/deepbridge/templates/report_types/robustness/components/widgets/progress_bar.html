<div class="progress-bar-widget" id="{{ id|default('progress-bar') }}">
    <div class="progress-info">
        {% if showValue %}
        <span class="progress-value" data-value="{{ value|default(0) }}">
            {% if valueType == 'percentage' %}
            {{ (value|default(0) * 100)|round|int }}%
            {% else %}
            {{ value|default(0) }}
            {% endif %}
        </span>
        {% endif %}
        
        {% if label %}
        <span class="progress-label">{{ label }}</span>
        {% endif %}
    </div>
    
    <div class="progress-bar-container">
        <div class="progress-bar" 
            style="width: {{ (value|default(0) * 100)|round|int }}%;"
            data-value="{{ value|default(0) }}"
            data-type="{{ type|default('default') }}"
        ></div>
        
        {% if showThresholds %}
        <div class="progress-thresholds">
            {% for threshold in thresholds %}
            <div class="progress-threshold" style="left: {{ threshold.value * 100 }}%;">
                <div class="threshold-line"></div>
                {% if threshold.label %}
                <div class="threshold-label">{{ threshold.label }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        {% if showSegments %}
        <div class="progress-segments">
            {% for segment in segments %}
            <div class="progress-segment" 
                 style="left: {{ segment.start * 100 }}%; width: {{ (segment.end - segment.start) * 100 }}%;" 
                 data-segment="{{ segment.label }}">
                <div class="segment-label">{{ segment.label }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    {% if showLegend %}
    <div class="progress-legend">
        {% for legend in legends %}
        <div class="legend-item">
            <span class="legend-color" style="background-color: {{ legend.color }};"></span>
            <span class="legend-label">{{ legend.label }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if description %}
    <div class="progress-description">
        {{ description }}
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initProgressBars();
    });

    function initProgressBars() {
        document.querySelectorAll('.progress-bar-widget').forEach(widget => {
            const progressBar = widget.querySelector('.progress-bar');
            if (!progressBar) return;
            
            // Set color based on value and type
            const value = parseFloat(progressBar.getAttribute('data-value')) || 0;
            const type = progressBar.getAttribute('data-type') || 'default';
            
            // Apply color based on type and value
            if (type === 'success-metric') {
                // Higher values are better
                if (value >= 0.8) {
                    progressBar.classList.add('excellent');
                } else if (value >= 0.6) {
                    progressBar.classList.add('good');
                } else if (value >= 0.4) {
                    progressBar.classList.add('moderate');
                } else if (value >= 0.2) {
                    progressBar.classList.add('fair');
                } else {
                    progressBar.classList.add('poor');
                }
            } else if (type === 'impact-metric') {
                // Lower values are better (impact metric)
                if (value <= 0.1) {
                    progressBar.classList.add('excellent');
                } else if (value <= 0.2) {
                    progressBar.classList.add('good');
                } else if (value <= 0.3) {
                    progressBar.classList.add('moderate');
                } else if (value <= 0.4) {
                    progressBar.classList.add('fair');
                } else {
                    progressBar.classList.add('poor');
                }
            } else {
                // Default coloring
                progressBar.classList.add('default');
            }
            
            // Animate progress bar width on initialize
            progressBar.style.transition = 'width 1s';
            
            // Add animation to value counter if present
            const valueSpan = widget.querySelector('.progress-value');
            if (valueSpan) {
                const targetValue = parseFloat(valueSpan.getAttribute('data-value')) || 0;
                const isPercentage = valueSpan.textContent.includes('%');
                
                // Animate from 0 to target value
                animateValue(valueSpan, 0, targetValue, 1000, isPercentage);
            }
        });
    }
    
    function animateValue(element, start, end, duration, isPercentage) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const currentValue = progress * (end - start) + start;
            
            if (isPercentage) {
                element.textContent = `${Math.floor(currentValue * 100)}%`;
            } else {
                element.textContent = currentValue.toFixed(2);
            }
            
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        
        window.requestAnimationFrame(step);
    }
</script>