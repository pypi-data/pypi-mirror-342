<!-- model_features.html -->
<div class="model-features-section">
    <div class="card">
        <h2>Model Features</h2>
        <p>Compare model's native feature importance with robustness impact.</p>
        
        <div class="model-feature-chart-container">
            <div id="model-feature-chart" class="chart-plot"></div>
        </div>
        
        <div class="features-comparison-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Feature</th>
                        <th>Model Importance</th>
                        <th>Robustness Impact</th>
                        <th>Difference</th>
                    </tr>
                </thead>
                <tbody id="model-features-data">
                    <!-- Data will be loaded by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Initialize model features when this tab is shown
    document.addEventListener('DOMContentLoaded', function() {
        // Add a listener for the model features tab button
        const modelFeaturesTabBtn = document.querySelector('.tab-btn[data-tab="model_features"]');
        if (modelFeaturesTabBtn) {
            modelFeaturesTabBtn.addEventListener('click', function() {
                console.log("Model features tab clicked, initializing model features data");
                initializeModelFeaturesView();
            });
        }
        
        function initializeModelFeaturesView() {
            // Create the model features chart
            if (typeof Plotly !== 'undefined') {
                createModelFeaturesChart();
                populateFeaturesComparisonTable();
            } else {
                console.error("Plotly is not available for model features charts");
                const chartElement = document.getElementById('model-feature-chart');
                if (chartElement) {
                    chartElement.innerHTML = "<div style='padding: 20px; text-align: center; color: red;'>Plotly library not loaded. Charts cannot be displayed.</div>";
                }
            }
        }
        
        function createModelFeaturesChart() {
            const chartElement = document.getElementById('model-feature-chart');
            if (!chartElement) return;
            
            try {
                // Get feature importance data
                let modelImportance = {};
                let robustnessImportance = {};
                
                if (window.reportConfig) {
                    modelImportance = window.reportConfig.model_feature_importance || {};
                    robustnessImportance = window.reportConfig.feature_importance || {};
                }
                
                if (Object.keys(modelImportance).length === 0 || Object.keys(robustnessImportance).length === 0) {
                    console.warn("Missing model or robustness feature importance data");
                    chartElement.innerHTML = "<div style='padding: 20px; text-align: center;'>Insufficient feature importance data available</div>";
                    return;
                }
                
                // Get common features (intersection)
                const modelFeatureSet = new Set(Object.keys(modelImportance));
                const impactFeatureSet = new Set(Object.keys(robustnessImportance));
                const commonFeatures = [...modelFeatureSet].filter(feature => impactFeatureSet.has(feature));
                
                if (commonFeatures.length === 0) {
                    console.warn("No common features found between model importance and robustness impact");
                    chartElement.innerHTML = "<div style='padding: 20px; text-align: center;'>No common features found between model importance and robustness impact</div>";
                    return;
                }
                
                // Sort by model importance
                commonFeatures.sort((a, b) => modelImportance[b] - modelImportance[a]);
                
                // Take top 10 features for readability
                const topFeatures = commonFeatures.slice(0, 10);
                
                // Prepare data for chart
                const modelValues = topFeatures.map(feature => modelImportance[feature]);
                const robustnessValues = topFeatures.map(feature => robustnessImportance[feature]);
                
                // Create traces for both metrics
                const modelTrace = {
                    x: topFeatures,
                    y: modelValues,
                    type: 'bar',
                    name: 'Model Importance',
                    marker: {
                        color: '#2980b9'
                    }
                };
                
                const robustnessTrace = {
                    x: topFeatures,
                    y: robustnessValues,
                    type: 'bar',
                    name: 'Robustness Impact',
                    marker: {
                        color: '#e74c3c'
                    }
                };
                
                // Layout for the chart
                const layout = {
                    title: 'Model Feature Importance vs Robustness Impact',
                    barmode: 'group',
                    xaxis: {
                        title: 'Feature',
                        tickangle: -45
                    },
                    yaxis: {
                        title: 'Importance'
                    },
                    margin: {
                        l: 50,
                        r: 50,
                        b: 120,
                        t: 50,
                        pad: 4
                    },
                    legend: {
                        x: 0,
                        y: 1.1,
                        orientation: 'h'
                    }
                };
                
                // Create the plot
                Plotly.newPlot(chartElement, [modelTrace, robustnessTrace], layout, {responsive: true});
                
            } catch (error) {
                console.error("Error creating model features chart:", error);
                chartElement.innerHTML = `<div style='padding: 20px; color: red;'>Error creating chart: ${error.message}</div>`;
            }
        }
        
        function populateFeaturesComparisonTable() {
            const tableBody = document.getElementById('model-features-data');
            if (!tableBody) return;
            
            try {
                // Clear existing content
                tableBody.innerHTML = '';
                
                // Get feature importance data
                let modelImportance = {};
                let robustnessImportance = {};
                
                if (window.reportConfig) {
                    modelImportance = window.reportConfig.model_feature_importance || {};
                    robustnessImportance = window.reportConfig.feature_importance || {};
                }
                
                if (Object.keys(modelImportance).length === 0 && Object.keys(robustnessImportance).length === 0) {
                    // No data available
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 5;
                    cell.textContent = 'No feature importance data available';
                    cell.style.textAlign = 'center';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                    return;
                }
                
                // Combine and sort features
                const allFeatures = new Set([...Object.keys(modelImportance), ...Object.keys(robustnessImportance)]);
                
                // Create an array of objects with feature info
                const featureInfos = [...allFeatures].map(feature => {
                    const modelImp = modelImportance[feature] || 0;
                    const robustnessImp = robustnessImportance[feature] || 0;
                    const difference = Math.abs(modelImp - robustnessImp);
                    
                    return {
                        feature,
                        modelImp,
                        robustnessImp,
                        difference
                    };
                });
                
                // Sort by difference (largest first)
                featureInfos.sort((a, b) => b.difference - a.difference);
                
                // Take top 20 features with the largest differences
                const topDifferences = featureInfos.slice(0, 20);
                
                // Add rows for each feature
                topDifferences.forEach((info, index) => {
                    const row = document.createElement('tr');
                    
                    // Rank
                    const rankCell = document.createElement('td');
                    rankCell.textContent = index + 1;
                    rankCell.style.textAlign = 'center';
                    
                    // Feature name
                    const featureCell = document.createElement('td');
                    featureCell.textContent = info.feature;
                    
                    // Model importance
                    const modelCell = document.createElement('td');
                    modelCell.textContent = info.modelImp ? (info.modelImp * 100).toFixed(2) + '%' : 'N/A';
                    
                    // Robustness impact
                    const robustnessCell = document.createElement('td');
                    robustnessCell.textContent = info.robustnessImp ? (info.robustnessImp * 100).toFixed(2) + '%' : 'N/A';
                    
                    // Difference
                    const diffCell = document.createElement('td');
                    diffCell.textContent = (info.difference * 100).toFixed(2) + '%';
                    
                    // Add emphasis to large differences
                    if (info.difference > 0.1) {
                        diffCell.style.color = '#e74c3c';
                        diffCell.style.fontWeight = 'bold';
                    }
                    
                    row.appendChild(rankCell);
                    row.appendChild(featureCell);
                    row.appendChild(modelCell);
                    row.appendChild(robustnessCell);
                    row.appendChild(diffCell);
                    
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error("Error populating features comparison table:", error);
                
                // Show error message
                tableBody.innerHTML = '';
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 5;
                cell.textContent = 'Error loading feature comparison data';
                cell.style.textAlign = 'center';
                cell.style.color = 'red';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        }
    });
</script>