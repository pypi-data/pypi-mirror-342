<div class="interactive-tooltip" 
    data-tooltip-id="{{ id|default('tooltip') }}"
    data-tooltip-text="{{ text|default('') }}"
    data-tooltip-position="{{ position|default('top') }}"
    data-tooltip-trigger="{{ trigger|default('hover') }}"
>
    {% if iconType == 'info' %}
    <span class="tooltip-trigger info-icon">ℹ️</span>
    {% elif iconType == 'question' %}
    <span class="tooltip-trigger question-icon">❓</span>
    {% elif iconType == 'warning' %}
    <span class="tooltip-trigger warning-icon">⚠️</span>
    {% elif iconType == 'custom' %}
    <span class="tooltip-trigger custom-icon">{{ customIcon }}</span>
    {% else %}
    <span class="tooltip-trigger">{{ content|default('?') }}</span>
    {% endif %}
    
    <div class="tooltip-content">
        <div class="tooltip-arrow"></div>
        <div class="tooltip-inner">
            {% if title %}
            <div class="tooltip-title">{{ title }}</div>
            {% endif %}
            <div class="tooltip-body">
                {% if text %}
                <p>{{ text }}</p>
                {% endif %}
                {% block tooltip_content %}
                <!-- This block can be overridden to provide custom tooltip content -->
                {% endblock %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initInteractiveTooltips();
    });

    function initInteractiveTooltips() {
        document.querySelectorAll('.interactive-tooltip').forEach(tooltip => {
            const trigger = tooltip.getAttribute('data-tooltip-trigger') || 'hover';
            const tooltipContent = tooltip.querySelector('.tooltip-content');
            const tooltipTrigger = tooltip.querySelector('.tooltip-trigger');
            
            if (!tooltipTrigger || !tooltipContent) return;
            
            // Position the tooltip based on data-tooltip-position
            const position = tooltip.getAttribute('data-tooltip-position') || 'top';
            tooltipContent.classList.add(`position-${position}`);
            
            // Handle tooltip trigger events
            if (trigger === 'hover') {
                tooltipTrigger.addEventListener('mouseenter', function() {
                    showTooltip(tooltipContent);
                });
                
                tooltipTrigger.addEventListener('mouseleave', function() {
                    hideTooltip(tooltipContent);
                });
            } else if (trigger === 'click') {
                tooltipTrigger.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Toggle tooltip visibility
                    if (tooltipContent.classList.contains('visible')) {
                        hideTooltip(tooltipContent);
                    } else {
                        // Hide all other tooltips first
                        document.querySelectorAll('.tooltip-content.visible').forEach(t => {
                            if (t !== tooltipContent) {
                                hideTooltip(t);
                            }
                        });
                        
                        showTooltip(tooltipContent);
                    }
                });
                
                // Close tooltip when clicking outside
                document.addEventListener('click', function(e) {
                    if (!tooltip.contains(e.target) && tooltipContent.classList.contains('visible')) {
                        hideTooltip(tooltipContent);
                    }
                });
            }
        });
    }

    function showTooltip(tooltipContent) {
        tooltipContent.classList.add('visible');
        
        // Position the tooltip to ensure it stays in viewport
        positionTooltip(tooltipContent);
    }

    function hideTooltip(tooltipContent) {
        tooltipContent.classList.remove('visible');
    }

    function positionTooltip(tooltipContent) {
        // Reset any previous positioning
        tooltipContent.style.left = '';
        tooltipContent.style.right = '';
        tooltipContent.style.top = '';
        tooltipContent.style.bottom = '';
        
        // Get tooltip and trigger dimensions and positions
        const tooltipRect = tooltipContent.getBoundingClientRect();
        const triggerRect = tooltipContent.parentElement.querySelector('.tooltip-trigger').getBoundingClientRect();
        const parentRect = tooltipContent.parentElement.getBoundingClientRect();
        
        // Check if tooltip would go off the screen
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Get the original position
        const position = tooltipContent.parentElement.getAttribute('data-tooltip-position') || 'top';
        
        // Adjust position if needed
        if (position === 'top' && triggerRect.top - tooltipRect.height < 0) {
            // Switch to bottom
            tooltipContent.classList.remove('position-top');
            tooltipContent.classList.add('position-bottom');
        } else if (position === 'bottom' && triggerRect.bottom + tooltipRect.height > viewportHeight) {
            // Switch to top
            tooltipContent.classList.remove('position-bottom');
            tooltipContent.classList.add('position-top');
        } else if (position === 'left' && triggerRect.left - tooltipRect.width < 0) {
            // Switch to right
            tooltipContent.classList.remove('position-left');
            tooltipContent.classList.add('position-right');
        } else if (position === 'right' && triggerRect.right + tooltipRect.width > viewportWidth) {
            // Switch to left
            tooltipContent.classList.remove('position-right');
            tooltipContent.classList.add('position-left');
        }
        
        // Center horizontally for top/bottom positions
        if (tooltipContent.classList.contains('position-top') || tooltipContent.classList.contains('position-bottom')) {
            const centerPosition = (triggerRect.left + triggerRect.right) / 2 - parentRect.left - (tooltipRect.width / 2);
            
            // Check if it would go off screen left or right
            if (centerPosition < 0) {
                tooltipContent.style.left = '0';
                
                // Adjust arrow position
                const arrow = tooltipContent.querySelector('.tooltip-arrow');
                if (arrow) {
                    arrow.style.left = `${triggerRect.left + (triggerRect.width / 2) - parentRect.left}px`;
                }
            } else if (centerPosition + tooltipRect.width > parentRect.width) {
                tooltipContent.style.right = '0';
                
                // Adjust arrow position
                const arrow = tooltipContent.querySelector('.tooltip-arrow');
                if (arrow) {
                    arrow.style.right = `${parentRect.right - triggerRect.right + (triggerRect.width / 2)}px`;
                }
            } else {
                tooltipContent.style.left = `${centerPosition}px`;
            }
        }
        
        // Center vertically for left/right positions
        if (tooltipContent.classList.contains('position-left') || tooltipContent.classList.contains('position-right')) {
            const centerPosition = (triggerRect.top + triggerRect.bottom) / 2 - parentRect.top - (tooltipRect.height / 2);
            
            // Check if it would go off screen top or bottom
            if (centerPosition < 0) {
                tooltipContent.style.top = '0';
                
                // Adjust arrow position
                const arrow = tooltipContent.querySelector('.tooltip-arrow');
                if (arrow) {
                    arrow.style.top = `${triggerRect.top + (triggerRect.height / 2) - parentRect.top}px`;
                }
            } else if (centerPosition + tooltipRect.height > parentRect.height) {
                tooltipContent.style.bottom = '0';
                
                // Adjust arrow position
                const arrow = tooltipContent.querySelector('.tooltip-arrow');
                if (arrow) {
                    arrow.style.bottom = `${parentRect.bottom - triggerRect.bottom + (triggerRect.height / 2)}px`;
                }
            } else {
                tooltipContent.style.top = `${centerPosition}px`;
            }
        }
    }
</script>