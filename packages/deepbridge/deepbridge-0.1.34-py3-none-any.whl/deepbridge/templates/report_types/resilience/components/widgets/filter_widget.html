<!-- filter_widget.html - placeholder -->
<!-- filter_widget.html - Filter widget for data display -->
<div class="filter-widget" id="{{ id|default('filter-widget') }}">
    <div class="filter-header">
        <h4 class="filter-title">{{ title|default('Filter Data') }}</h4>
        {% if collapsible %}
        <button class="filter-toggle" data-target="{{ id|default('filter-widget') }}-content">
            <span class="toggle-icon">{% if collapsed %}▼{% else %}▲{% endif %}</span>
        </button>
        {% endif %}
    </div>
    
    <div class="filter-content" id="{{ id|default('filter-widget') }}-content" {% if collapsed %}style="display: none;"{% endif %}>
        <!-- Search filter -->
        <div class="filter-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="{{ id|default('filter-widget') }}-search" 
                    class="filter-search" 
                    placeholder="{{ search_placeholder|default('Search...') }}"
                    data-controller="{{ controller }}"
                >
                <button class="search-clear" id="{{ id|default('filter-widget') }}-search-clear" aria-label="Clear search">×</button>
            </div>
        </div>
        
        {% if has_feature_filter %}
        <!-- Feature type filter -->
        <div class="filter-section">
            <label class="filter-label">Feature Type:</label>
            <div class="filter-options">
                <label class="filter-option">
                    <input 
                        type="radio" 
                        name="{{ id|default('filter-widget') }}-feature-type" 
                        value="all" 
                        checked
                        data-controller="{{ controller }}"
                    >
                    <span>All Features</span>
                </label>
                <label class="filter-option">
                    <input 
                        type="radio" 
                        name="{{ id|default('filter-widget') }}-feature-type" 
                        value="numerical"
                        data-controller="{{ controller }}"
                    >
                    <span>Numerical</span>
                </label>
                <label class="filter-option">
                    <input 
                        type="radio" 
                        name="{{ id|default('filter-widget') }}-feature-type" 
                        value="categorical"
                        data-controller="{{ controller }}"
                    >
                    <span>Categorical</span>
                </label>
            </div>
        </div>
        {% endif %}
        
        {% if has_shift_filter %}
        <!-- Shift magnitude filter -->
        <div class="filter-section">
            <label class="filter-label">Shift Magnitude:</label>
            <div class="range-selector">
                <div class="range-labels">
                    <span>Minor</span>
                    <span>Moderate</span>
                    <span>Significant</span>
                </div>
                <input 
                    type="range" 
                    id="{{ id|default('filter-widget') }}-shift-magnitude" 
                    class="range-input"
                    min="0" 
                    max="1" 
                    step="0.01" 
                    value="0"
                    data-controller="{{ controller }}"
                >
                <div class="range-value-display">
                    <span>Min: </span>
                    <span id="{{ id|default('filter-widget') }}-shift-value">0</span>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if has_performance_filter %}
        <!-- Performance impact filter -->
        <div class="filter-section">
            <label class="filter-label">Performance Impact:</label>
            <div class="filter-options checkbox-options">
                <label class="filter-option">
                    <input 
                        type="checkbox" 
                        name="{{ id|default('filter-widget') }}-performance" 
                        value="high"
                        data-controller="{{ controller }}"
                        checked
                    >
                    <span>High Impact</span>
                </label>
                <label class="filter-option">
                    <input 
                        type="checkbox" 
                        name="{{ id|default('filter-widget') }}-performance" 
                        value="medium"
                        data-controller="{{ controller }}"
                        checked
                    >
                    <span>Medium Impact</span>
                </label>
                <label class="filter-option">
                    <input 
                        type="checkbox" 
                        name="{{ id|default('filter-widget') }}-performance" 
                        value="low"
                        data-controller="{{ controller }}"
                        checked
                    >
                    <span>Low Impact</span>
                </label>
            </div>
        </div>
        {% endif %}
        
        {% if has_metric_filter %}
        <!-- Metric filter -->
        <div class="filter-section">
            <label class="filter-label">Distribution Metric:</label>
            <div class="filter-options">
                <label class="filter-option">
                    <input 
                        type="radio" 
                        name="{{ id|default('filter-widget') }}-metric" 
                        value="kl_divergence"
                        data-controller="{{ controller }}"
                        {% if active_metric == 'kl_divergence' %}checked{% endif %}
                    >
                    <span>KL Divergence</span>
                </label>
                <label class="filter-option">
                    <input 
                        type="radio" 
                        name="{{ id|default('filter-widget') }}-metric" 
                        value="js_distance"
                        data-controller="{{ controller }}"
                        {% if active_metric == 'js_distance' %}checked{% endif %}
                    >
                    <span>JS Distance</span>
                </label>
                <label class="filter-option">
                    <input 
                        type="radio" 
                        name="{{ id|default('filter-widget') }}-metric" 
                        value="wasserstein"
                        data-controller="{{ controller }}"
                        {% if active_metric == 'wasserstein' %}checked{% endif %}
                    >
                    <span>Wasserstein</span>
                </label>
            </div>
        </div>
        {% endif %}
        
        {% if show_apply_button %}
        <div class="filter-actions">
            <button 
                class="apply-filter-btn" 
                id="{{ id|default('filter-widget') }}-apply"
                data-controller="{{ controller }}"
            >
                Apply Filter
            </button>
            <button 
                class="reset-filter-btn" 
                id="{{ id|default('filter-widget') }}-reset"
                data-controller="{{ controller }}"
            >
                Reset
            </button>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initFilterWidget('{{ id|default("filter-widget") }}', '{{ controller }}');
    });

    function initFilterWidget(filterId, controllerName) {
        const filterWidget = document.getElementById(filterId);
        if (!filterWidget) return;
        
        // Handle collapsible functionality
        const toggleBtn = filterWidget.querySelector('.filter-toggle');
        if (toggleBtn) {
            const targetId = toggleBtn.getAttribute('data-target');
            const targetContent = document.getElementById(targetId);
            const icon = toggleBtn.querySelector('.toggle-icon');
            
            toggleBtn.addEventListener('click', function() {
                if (targetContent.style.display === 'none') {
                    targetContent.style.display = 'block';
                    if (icon) icon.textContent = '▲';
                } else {
                    targetContent.style.display = 'none';
                    if (icon) icon.textContent = '▼';
                }
            });
        }
        
        // Handle search clear button
        const searchInput = filterWidget.querySelector('.filter-search');
        const clearBtn = filterWidget.querySelector('.search-clear');
        if (searchInput && clearBtn) {
            // Show/hide clear button based on input content
            searchInput.addEventListener('input', function() {
                clearBtn.style.visibility = this.value ? 'visible' : 'hidden';
            });
            
            // Initialize clear button visibility
            clearBtn.style.visibility = searchInput.value ? 'visible' : 'hidden';
            
            // Clear search input when button is clicked
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                searchInput.focus();
                clearBtn.style.visibility = 'hidden';
                
                // Trigger input event to update filtering
                searchInput.dispatchEvent(new Event('input'));
                
                // Call controller if defined
                if (controllerName && window[controllerName]) {
                    window[controllerName]('searchClear');
                }
            });
        }
        
        // Handle range input display
        const rangeInput = filterWidget.querySelector('.range-input');
        const rangeDisplay = filterWidget.querySelector(`#${filterId}-shift-value`);
        
        if (rangeInput && rangeDisplay) {
            rangeInput.addEventListener('input', function() {
                rangeDisplay.textContent = this.value;
                
                // Call controller if defined
                if (controllerName && window[controllerName]) {
                    window[controllerName]('rangeChange', this.value);
                }
            });
        }
        
        // Handle apply button if present
        const applyBtn = filterWidget.querySelector('.apply-filter-btn');
        if (applyBtn) {
            applyBtn.addEventListener('click', function() {
                // Collect all filter settings
                const settings = {
                    search: searchInput ? searchInput.value : '',
                    featureType: getSelectedRadioValue(filterWidget, `${filterId}-feature-type`),
                    shiftMagnitude: rangeInput ? rangeInput.value : 0,
                    performanceImpact: getCheckedCheckboxValues(filterWidget, `${filterId}-performance`),
                    metric: getSelectedRadioValue(filterWidget, `${filterId}-metric`)
                };
                
                // Call controller if defined
                if (controllerName && window[controllerName]) {
                    window[controllerName]('applyFilters', settings);
                }
            });
        }
        
        // Handle reset button if present
        const resetBtn = filterWidget.querySelector('.reset-filter-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                // Reset all form elements
                if (searchInput) {
                    searchInput.value = '';
                    clearBtn.style.visibility = 'hidden';
                }
                
                // Reset radio buttons to first option
                resetRadioButtons(filterWidget);
                
                // Reset range slider
                if (rangeInput) {
                    rangeInput.value = rangeInput.min || 0;
                    if (rangeDisplay) rangeDisplay.textContent = rangeInput.value;
                }
                
                // Reset checkboxes
                resetCheckboxes(filterWidget);
                
                // Call controller if defined
                if (controllerName && window[controllerName]) {
                    window[controllerName]('resetFilters');
                }
            });
        }
        
        // Helper functions
        function getSelectedRadioValue(container, name) {
            const selected = container.querySelector(`input[name="${name}"]:checked`);
            return selected ? selected.value : null;
        }
        
        function getCheckedCheckboxValues(container, name) {
            const checked = container.querySelectorAll(`input[name="${name}"]:checked`);
            return Array.from(checked).map(input => input.value);
        }
        
        function resetRadioButtons(container) {
            const radioGroups = container.querySelectorAll('input[type="radio"]');
            const groupNames = new Set(Array.from(radioGroups).map(radio => radio.name));
            
            groupNames.forEach(name => {
                const firstRadio = container.querySelector(`input[name="${name}"]:first-of-type`);
                if (firstRadio) firstRadio.checked = true;
            });
        }
        
        function resetCheckboxes(container) {
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true; // Default to checked
            });
        }
    }
</script>