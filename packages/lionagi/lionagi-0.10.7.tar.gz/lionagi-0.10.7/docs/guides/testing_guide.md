---
title:  "khive Testing Guide"
by:     "khive Team"
created: "2025-04-05"
updated: "2025-04-18"
version: "1.6"
description: >
  Pragmatic TDD workflow for khive.  Tests double as living documentation.
  CI (and the local `khive ci` script) require **â‰¥ 80 pct combined line coverage**:
  - ! WARNING---K.D KHIVE-DEV TEAM MUST RETAIN FROM  EDITING THIS DOCUMENT.
  - ! WARNING: THIS DOCUMENT IS READ-ONLY
---

! WARNING: THIS DOCUMENT IS READ-ONLY

## 1 Â· Why we test

- Guard against regressions.
- Document behaviour (well-named tests are the best docs).
- Give reviewers confidence to merge quickly.

---

## 2 Â· Test stack in one table

| Layer                     | Runner / Tooling                                 | Mocking                          | Coverage file                                        |
| ------------------------- | ------------------------------------------------ | -------------------------------- | ---------------------------------------------------- |
| **Frontend** (React + TS) | **Vitest** + React Testing Library (`pnpm test`) | `vi.mock` for Tauri APIs         | `apps/khive-ui/coverage/coverage-summary.json`       |
| **Backend** (Rust)        | `cargo test`                                     | Trait fakes / `mockito` for HTTP | tarpaulin JSON (auto-generated by `cargo tarpaulin`) |
| **Combined check**        | `./scripts/khive ci` (runs both stacks)          | â€”                                | calc'ed on the fly                                   |

> **Tipâ€ƒ**Run `khive ci --threshold 80` locally before you push - it's the same
> command CI runs.

---

## 3 Â· Frontend setup (Vitest)

1. **Global test harness** - create `apps/khive-ui/src/test/setup.ts`:

   ```ts
   import "@testing-library/jest-dom/vitest";
   import { afterEach, vi } from "vitest";
   import { cleanup } from "@testing-library/react";

   // Mock the bits of Tauri we call from the browser side
   vi.mock("@tauri-apps/api/core", () => ({
     invoke: vi.fn().mockResolvedValue(undefined),
   }));
   vi.mock("@tauri-apps/api/event", () => ({
     listen: vi.fn().mockResolvedValue(() => {}), // returns â€œunlistenâ€
     emit:   vi.fn(),
   }));

   afterEach(() => {
     cleanup();
     vi.clearAllMocks();
   });

   2.	vite.config.ts
   ```

test: { globals: true, environment: "jsdom", setupFiles: "src/test/setup.ts",
coverage: { reporter: ["json-summary", "text"] }, }

    3.	Custom render() helper - wrap components with QueryClientProvider,

MemoryRouter, etc. (lives in src/test/TestSetup.tsx).

â¸»

4 Â· Backend tests (Rust) â€¢	Unit tests live beside src (mod tests { â€¦ },
#[tokio::test]). â€¢	Integration tests go in tests/â€”call your Tauri command
handlers directly or test the pure logic they delegate to. â€¢	Need network? Use
mockito. â€¢	Generate coverage locally:

cargo tarpaulin --ignore-tests --out Json --workspace\
--engine llvm --output-dir target/tarpaulin

â¸»

5 Â· Writing good tests

Do	Don't Arrange - Act - Assert block comments	Assert more than one thing per
assertion Name tests as a spec: should_toggle_dark_mode	test1 / misc Mock at
boundaries (Tauri invoke, HTTP)	Deep-mock React internals Prefer small, pure
functions â†’ easy unit tests	Monster integration test suites only

â¸»

6 Â· Coverage rule (80 pct) â€¢	khive ci merges frontend+backend line counts - no
excuses. â€¢	If you REALLY can't hit 80 pct, add tests or negotiate a scope slice
with the architect before PR.

â¸»

7 Â· Local TDD loop

# 1. Red - write a failing test

pnpm test path/to/Component.test.tsx

# 2. Green - implement / refactor

cargo test -p my_backend_crate

# 3. Refactor - keep tests green

khive ci # combined coverage & template lint

Repeat until happy âžœ khive commit, khive pr.

â¸»

8 Â· CI pipeline (for reference) 1.	khive-init (installs deps, hooks). 2.	pnpm
test -- --coverage 3.	cargo test (workspace) 4.	khive ci - fails if coverage <
threshold or placeholders remain in docs. 5.	Reviewers check search citations,
approve.

â¸»

9 Â· Troubleshooting â€¢	Coverage stuck at 0 pct (FE) - ensure Vitest reporter
json-summary is enabled (see section 3). â€¢	tarpaulin slow - pass --skip-clean
during local runs. â€¢	Mocks leaking between tests - call vi.clearAllMocks() in
afterEach. â€¢	CI says â€œplaceholders leftâ€ - run grep -R "{{PLACEHOLDER" and fill
them, or re-generate via khive new-doc.

Happy testing ðŸ§ª
