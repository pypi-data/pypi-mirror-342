version: '3.7'

services:
  datadog:
    container_name: datadog
    image: datadog/agent:latest
    expose:
      - 5555
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_HOSTNAME=${HMD_HOSTNAME}
      - DD_HEALTH_PORT=5555
      - DD_ENV=local
      - DD_APM_ENABLED=true
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      - DD_LOGS_CONFIG_DOCKER_CONTAINER_USE_FILE=true
      - DD_CONTAINER_EXCLUDE=name:datadog
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
      - 'DD_DOCKER_LABELS_AS_TAGS={"io.hmdlabs.service": "service", "io.hmdlabs.environment": "env", "io.hmdlabs.version": "version"}'
      - 'DD_DOCKER_ENV_AS_TAGS={"HMD_REPO_HOME": "repo_name", "HMD_INSTANCE_NAME": "instance_name", "HMD_CUSTOMER_CODE": "customer_code"}'
      - HMD_CUSTOMER_CODE=${HMD_CUSTOMER_CODE}
      - HMD_DID=${HMD_DID:-aaa}
      - HMD_ENVIRONMENT=local
      - HMD_REGION=${HMD_REGION}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
      - type: bind
        source: ${HMD_HOME}/datadog/s6
        target: /var/run/s6
      - type: bind
        source: ${HMD_HOME}/datadog/log
        target: /var/log/datadog
