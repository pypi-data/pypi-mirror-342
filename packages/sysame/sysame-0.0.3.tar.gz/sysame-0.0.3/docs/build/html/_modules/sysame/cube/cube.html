

<!DOCTYPE html>
<html class="writer-html5" lang="python" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sysame.cube.cube &mdash; sysame 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=c0b50fd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            sysame
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cube.html">Cube Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/matrix.html">Matrix Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/matsim.html">MATSim Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/plotting.html">Plotting Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/saturn.html">SATURN Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">sysame</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sysame.cube.cube</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sysame.cube.cube</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for Cube processes.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##### IMPORTS #####</span>
<span class="c1"># Standard imports</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># Third party imports</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">polars</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="c1"># Local imports</span>

<span class="c1">##### CONSTANTS #####</span>

<span class="c1">##### CLASSES #####</span>


<span class="c1">##### FUNCTIONS #####</span>
<div class="viewcode-block" id="Node">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.Node">[docs]</a>
<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple node class for representing network nodes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string : str or int</span>
<span class="sd">        String representation of the node.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Additional attributes to be assigned to the node.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    id : int</span>
<span class="sd">        Node identifier, absolute value from string.</span>
<span class="sd">    stopping : bool</span>
<span class="sd">        Whether the node is a stopping point.</span>
<span class="sd">    _string : str</span>
<span class="sd">        Internal storage of the original string representation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary with user-defined attributes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Any]</span>
<span class="sd">            Dictionary of custom attributes excluding internal ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">and</span> <span class="s2">&quot;id&quot;</span> <span class="o">!=</span> <span class="n">k</span> <span class="ow">and</span> <span class="s2">&quot;ID&quot;</span> <span class="o">!=</span> <span class="n">k</span> <span class="ow">and</span> <span class="s2">&quot;stopping&quot;</span> <span class="o">!=</span> <span class="n">k</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Object&#39;s summary representation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            String representation of the node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">stopping</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">node_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude_node_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation of the node.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node_attrs : list of str, optional</span>
<span class="sd">            List of node attributes to include.</span>
<span class="sd">        exclude_node_attrs : list of str, optional</span>
<span class="sd">            List of node attributes to omit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            String representation of the node with selected attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">txt_node</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">stopping</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node_attrs</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">node_attrs</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span>

            <span class="k">if</span> <span class="n">exclude_node_attrs</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_node_attrs</span><span class="p">}</span>

            <span class="n">formatted_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

            <span class="n">txt_attrs</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_attrs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">txt_attrs</span><span class="p">:</span>
                <span class="n">txt_node</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">txt_node</span><span class="p">,</span> <span class="n">txt_attrs</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">txt_node</span>

<div class="viewcode-block" id="Node.copy">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.Node.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Node&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a deep copy of the node.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Node</span>
<span class="sd">            A new instance that is a deep copy of this node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Line">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.Line">[docs]</a>
<span class="k">class</span> <span class="nc">Line</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple line class representing a sequence of nodes.</span>

<span class="sd">    A line is a sequence of nodes with its own properties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nodes : list of Node</span>
<span class="sd">        List of node objects that form the line.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Additional attributes to be assigned to the line.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    nodes : list of Node</span>
<span class="sd">        List of nodes that form the line.</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the line (set via kwargs).</span>
<span class="sd">    unquoted : list of str</span>
<span class="sd">        Class variable that defines values that should not be quoted.</span>
<span class="sd">    NodeLabel : str</span>
<span class="sd">        Label to identify nodes in string representation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Class variables</span>
    <span class="n">unquoted</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]</span>
    <span class="n">NodeLabel</span> <span class="o">=</span> <span class="s2">&quot;N&quot;</span>  <span class="c1"># Or &#39;NODE&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Node</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a line object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nodes : list[Node]</span>
<span class="sd">            List of node objects that form the line.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional attributes to be assigned to the line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>  <span class="c1"># a list of node objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Use NAME if present, empty string if not</span>

        <span class="c1"># Remove NAME from kwargs to avoid duplication</span>
        <span class="k">if</span> <span class="s2">&quot;NAME&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary with user-defined attributes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Any]</span>
<span class="sd">            Dictionary of line attributes excluding nodes and internal ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;nodes&quot;</span> <span class="o">!=</span> <span class="n">k</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of the nodes that are actual stops.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[Node]</span>
<span class="sd">            List of nodes marked as stopping points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">stopping</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Object&#39;s summary representation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            String summary of the line including node count and attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Line with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span><span class="si">}</span><span class="s2"> nodes (of which </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stops</span><span class="p">)</span><span class="si">}</span><span class="s2"> are stops).&quot;</span>
        <span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">txt</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude_line_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">node_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude_node_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation of the line.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        line_attrs : list of str, optional</span>
<span class="sd">            List of line attributes to include.</span>
<span class="sd">        exclude_line_attrs : list of str, optional</span>
<span class="sd">            List of line attributes to omit.</span>
<span class="sd">        node_attrs : list of str, optional</span>
<span class="sd">            List of node attributes to include.</span>
<span class="sd">        exclude_node_attrs : list of str, optional</span>
<span class="sd">            List of node attributes to omit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            String representation of the line with selected attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># String attributes are quoted, with exceptions</span>
        <span class="n">formatted_attrs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">line_attrs</span><span class="p">:</span>
            <span class="n">l_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">line_attrs</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span>

        <span class="k">if</span> <span class="n">exclude_line_attrs</span><span class="p">:</span>
            <span class="n">l_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_line_attrs</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unquoted</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>  <span class="c1"># This will enclose in the right quotes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">formatted_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">txt_attrs</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_attrs</span><span class="p">)</span>

        <span class="c1"># First nodes, and nodes after attributes, are labeled</span>
        <span class="n">formatted_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">first_node</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">n_str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">n</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">node_attrs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exclude_node_attrs</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">n</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">node_attrs</span><span class="p">,</span> <span class="n">exclude_node_attrs</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">first_node</span><span class="p">:</span>
                <span class="n">formatted_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">NodeLabel</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">n_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">first_node</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formatted_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_str</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">node_attrs</span><span class="p">:</span>
                <span class="n">n_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">node_attrs</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_attrs</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">attrs</span>

            <span class="k">if</span> <span class="n">exclude_node_attrs</span><span class="p">:</span>
                <span class="n">n_attrs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">n_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_node_attrs</span>
                <span class="p">}</span>

            <span class="k">if</span> <span class="n">n_attrs</span><span class="p">:</span>
                <span class="c1"># node has attributes printed, reset the flag:</span>
                <span class="n">first_node</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">txt_nodes</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_nodes</span><span class="p">)</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;LINE </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">txt_attrs</span><span class="p">,</span><span class="w"> </span><span class="n">txt_nodes</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;, TF=&quot;</span><span class="p">,</span> <span class="s2">&quot;,</span><span class="se">\n\t</span><span class="s2">TF=&quot;</span><span class="p">)</span>  <span class="c1"># prettify</span>

        <span class="k">return</span> <span class="n">txt</span>

<div class="viewcode-block" id="Line.is_node">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.Line.is_node">[docs]</a>
    <span class="k">def</span> <span class="nf">is_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Node</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if n is one of the line&#39;s nodes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : Node or int</span>
<span class="sd">            Node or node ID to check.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the node is part of the line, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span></div>


<div class="viewcode-block" id="Line.is_stop">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.Line.is_stop">[docs]</a>
    <span class="k">def</span> <span class="nf">is_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Node</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if line stops at n.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : Node or int</span>
<span class="sd">            Node or node ID to check.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the node is a stopping point on the line, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stops</span><span class="p">]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stop_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a concatenation of line&#39;s stops.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sep : str, default=&quot;_&quot;</span>
<span class="sd">            Separator to use between stop IDs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Concatenated string of stop IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stops</span><span class="p">])</span>

<div class="viewcode-block" id="Line.from_string">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.Line.from_string">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">potential_seps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Line&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a string representation into a line object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        string : str</span>
<span class="sd">            String to parse.</span>
<span class="sd">        potential_seps : Optional[list[str]], default=None</span>
<span class="sd">            List of potential separators to detect.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Line</span>
<span class="sd">            Parsed line object.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If invalid node declarations are found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">potential_seps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">potential_seps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">]</span>

        <span class="c1"># Guess the separator as the most common of potential separators:</span>
        <span class="n">formatted</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[=,][\s\n\t]+&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>  <span class="c1"># clean</span>
        <span class="c1"># Accounts for multiple separators.</span>
        <span class="n">seps_count</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sep</span><span class="si">}</span><span class="s2">+&quot;</span><span class="p">,</span> <span class="n">formatted</span><span class="p">))</span> <span class="k">for</span> <span class="n">sep</span> <span class="ow">in</span> <span class="n">potential_seps</span><span class="p">]</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">potential_seps</span><span class="p">[</span><span class="n">seps_count</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">seps_count</span><span class="p">))]</span>

        <span class="c1"># Clean:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1a</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># EOF windows &gt;_&lt;</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\ALINE\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\s,]*\Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sep</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sep</span><span class="si">}</span><span class="s2">*=</span><span class="si">{</span><span class="n">sep</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>

        <span class="c1"># src for this amazing magic:</span>
        <span class="c1"># https://stackoverflow.com/a/16710842/2802352</span>
        <span class="n">parts_pat</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;(?:[&quot;](?:</span><span class="se">\\</span><span class="s2">.|[^&quot;])*[&quot;]|[&#39;](?:</span><span class="se">\\</span><span class="s2">.|[^&#39;])*[&#39;]|[^</span><span class="si">{</span><span class="n">sep</span><span class="si">}</span><span class="s2">&quot;]|[^</span><span class="si">{</span><span class="n">sep</span><span class="si">}</span><span class="s2">&#39;])+&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">parts_pat</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>

        <span class="n">node_label_pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\A\s*N(?:ODES)?\b&quot;</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line_attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">node_attrs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attrs_section</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">while</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Clean:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\s,]*\Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># For numbers</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_label_pat</span><span class="si">}</span><span class="s2">\s*=\s*&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)):</span>
                <span class="n">attrs_section</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">attrs_section</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">line_attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">})</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Replace the node label</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_label_pat</span><span class="si">}</span><span class="s2">\s*=\s*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_label_pat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Node declaration in attribute &quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;in node </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">, line:</span><span class="se">\n</span><span class="si">{</span><span class="n">line_attrs</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="c1"># Still has &#39;=&#39;, must be an attribute:</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">node_attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">})</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># It is a node:</span>
                    <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                        <span class="c1"># Add the previous node, with the attrs read so far</span>
                        <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">node_attrs</span><span class="p">))</span>
                        <span class="n">node_attrs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># reset</span>

                    <span class="n">n</span> <span class="o">=</span> <span class="n">p</span>  <span class="c1"># Set the new node for future attrs to be read</span>

        <span class="c1"># Add the last node (if it is not empty)</span>
        <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">node_attrs</span><span class="p">))</span>

        <span class="n">ln</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="o">**</span><span class="n">line_attrs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ln</span></div>


<div class="viewcode-block" id="Line.copy">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.Line.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Line&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a deep copy of the line.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Line</span>
<span class="sd">            A new instance that is a deep copy of this line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LineFile">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.LineFile">[docs]</a>
<span class="k">class</span> <span class="nc">LineFile</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing a file of lines.</span>

<span class="sd">    A LineFile is a collection of line objects and comments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    content : list of (Line or str), optional</span>
<span class="sd">        List of line objects and comment strings.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    content : list of (Line or str)</span>
<span class="sd">        List containing line objects and comment strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Line</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_warn_if_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additional_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raises a warning if there are lines with duplicated NAME in the LineFile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        additional_info : str, optional</span>
<span class="sd">            Additional information to include in the warning message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_unique</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Several lines have the same NAME.&quot;</span>
            <span class="k">if</span> <span class="n">additional_info</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">additional_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content_duplicates_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Line</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the LineFile&#39;s content with duplicated NAMEs renamed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            Copy of content with renamed lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">renamed_content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">)</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Line</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># Treats int = str</span>
                <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">newname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffixes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">suffixes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">newname</span>
            <span class="n">renamed_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># re-test (recursive)</span>
        <span class="n">ren_sys</span> <span class="o">=</span> <span class="n">LineFile</span><span class="p">(</span><span class="n">renamed_content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ren_sys</span><span class="o">.</span><span class="n">name_unique</span><span class="p">:</span>
            <span class="n">renamed_content</span> <span class="o">=</span> <span class="n">ren_sys</span><span class="o">.</span><span class="n">content_duplicates_renamed</span>

        <span class="k">return</span> <span class="n">renamed_content</span>

<div class="viewcode-block" id="LineFile.rename_duplicates">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.LineFile.rename_duplicates">[docs]</a>
    <span class="k">def</span> <span class="nf">rename_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the LineFile&#39;s content to avoid lines with duplicated NAMEs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_duplicates_renamed</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if lines&#39; property &quot;NAME&quot; is a unique identifier.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if all line names are unique, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of comments in the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            All comments in the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Line</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary of lines by NAME.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Line]</span>
<span class="sd">            Dictionary of lines with NAME as key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Only the latest line is displayed for conflicting NAMEs.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_if_duplicates</span><span class="p">(</span><span class="n">additional_info</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Line</span><span class="p">)}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lines_duplicates_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Line</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary of lines with duplicated NAMEs renamed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Line]</span>
<span class="sd">            Dictionary of lines with NAME as key, duplicates renamed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_duplicates_renamed</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Line</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">line_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of line names as strings.</span>

<span class="sd">        Preserves order. May contain duplicates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[str]</span>
<span class="sd">            List of line names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Line</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Object&#39;s summary representation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            String representation summarizing the LineFile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_if_duplicates</span><span class="p">()</span>
        <span class="c1"># Using self.line_names avoids triggering further warnings:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;LineFile with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> lines, &quot;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span><span class="si">}</span><span class="s2"> comments.&quot;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lines:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">])</span>  <span class="c1"># if int NAMEs</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comments:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">txt</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">comments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">rename_duplicates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Representation as the file itself.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sort : bool, default=False</span>
<span class="sd">            If False, output is sorted with the same structure as input content.</span>
<span class="sd">            If True, comments are first, then all lines in NAME order.</span>
<span class="sd">        comments : bool, default=True</span>
<span class="sd">            Output comments only if True.</span>
<span class="sd">        rename_duplicates : bool, default=False</span>
<span class="sd">            Rename duplicated NAMEs if True.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional keyword arguments to pass to the line.__str__ method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            String representation of the LineFile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rename_duplicates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warn_if_duplicates</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span>
            <span class="c1"># Use only if there are duplicates. Makes code more compact:</span>
            <span class="k">if</span> <span class="n">rename_duplicates</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_unique</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_duplicates_renamed</span>

            <span class="c1"># Use str() instead of .__str__() directly</span>
            <span class="n">sorted_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="n">ln</span><span class="p">]</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lines</span><span class="p">)]</span>
            <span class="n">txt_lines</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sorted_lines</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
                <span class="n">txt_comments</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">])</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">txt_comments</span><span class="p">,</span> <span class="n">txt_lines</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">txt_lines</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>
            <span class="c1"># Use only if there are duplicates. Makes code more compact:</span>
            <span class="k">if</span> <span class="n">rename_duplicates</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_unique</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_duplicates_renamed</span>

            <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
                <span class="n">txt_content</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">txt_content</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="p">]</span>

            <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">txt_content</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">txt</span>

<div class="viewcode-block" id="LineFile.copy">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.LineFile.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LineFile&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a deep copy of the LineFile.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineFile</span>
<span class="sd">            A new instance that is a deep copy of this LineFile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="LineFile.save">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.LineFile.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">comments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">node_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude_node_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">line_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude_line_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rename_duplicates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the LineFile to a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to the output file.</span>
<span class="sd">        sort : bool, default=False</span>
<span class="sd">            If True, sorts the output.</span>
<span class="sd">        comments : bool, default=True</span>
<span class="sd">            If True, includes comments in the output.</span>
<span class="sd">        node_attrs : list of str, optional</span>
<span class="sd">            List of node attributes to include.</span>
<span class="sd">        exclude_node_attrs : list of str, optional</span>
<span class="sd">            List of node attributes to omit.</span>
<span class="sd">        line_attrs : list of str, optional</span>
<span class="sd">            List of line attributes to include.</span>
<span class="sd">        exclude_line_attrs : list of str, optional</span>
<span class="sd">            List of line attributes to omit.</span>
<span class="sd">        rename_duplicates : bool, default=True</span>
<span class="sd">            If True, renames duplicate line names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_unique</span> <span class="ow">and</span> <span class="n">rename_duplicates</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Duplicated NAMES will be renamed.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warn_if_duplicates</span><span class="p">(</span><span class="n">additional_info</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofile</span><span class="p">:</span>
            <span class="c1"># Use the method directly instead of the str() built-in</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">,</span>
                <span class="n">node_attrs</span><span class="o">=</span><span class="n">node_attrs</span><span class="p">,</span>
                <span class="n">exclude_node_attrs</span><span class="o">=</span><span class="n">exclude_node_attrs</span><span class="p">,</span>
                <span class="n">line_attrs</span><span class="o">=</span><span class="n">line_attrs</span><span class="p">,</span>
                <span class="n">exclude_line_attrs</span><span class="o">=</span><span class="n">exclude_line_attrs</span><span class="p">,</span>
                <span class="n">rename_duplicates</span><span class="o">=</span><span class="n">rename_duplicates</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span></div>


<div class="viewcode-block" id="LineFile.lines_by_attr">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.LineFile.lines_by_attr">[docs]</a>
    <span class="k">def</span> <span class="nf">lines_by_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Line</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of lines having a specific value in an attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attr : str</span>
<span class="sd">            Attribute name to check.</span>
<span class="sd">        val : Any</span>
<span class="sd">            Value to match.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[Line]</span>
<span class="sd">            List of lines that match the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="LineFile.lines_query">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.LineFile.lines_query">[docs]</a>
    <span class="k">def</span> <span class="nf">lines_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qry</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Line</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of lines meeting a SQL-like query.</span>

<span class="sd">        This relies on pandas DataFrame query:</span>
<span class="sd">            https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.query.html</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        qry : str</span>
<span class="sd">            SQL-like query string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[Line]</span>
<span class="sd">            List of lines that match the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lns_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">qry</span><span class="p">)[</span><span class="s2">&quot;NAME&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">lns_names</span><span class="p">:</span>
            <span class="n">lns</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lns_names</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">lns</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dataframe with the attributes for each line.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame containing line attributes as columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assume lines start on 1:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">ln</span><span class="o">.</span><span class="n">attrs</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ln</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># stops and nodes are objects!</span>
        <span class="n">additional_attrs</span> <span class="o">=</span> <span class="s2">&quot;stop_seq stops nodes&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">additional_attrs</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_extract_blocks</span><span class="p">(</span>
        <span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">block_pat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?s)(?:(;.*?|\n\s*)\n|LINE\s+(.*?)(?=\n\s*LINE|\n\s*;|\Z))&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of tuples [(comment, line), (), ...] for each record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        string : str</span>
<span class="sd">            Input string to parse.</span>
<span class="sd">        block_pat : str, default regex pattern</span>
<span class="sd">            Regex pattern to extract blocks.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[Tuple[str, str]]</span>
<span class="sd">            List of tuples containing (comment, line) pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">block_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">block_pat</span><span class="p">)</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">block_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blocks</span>

<div class="viewcode-block" id="LineFile.from_string">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.LineFile.from_string">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LineFile&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a LineFile from a string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        string : str</span>
<span class="sd">            String representation of a line file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineFile</span>
<span class="sd">            Parsed LineFile object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">LineFile</span><span class="o">.</span><span class="n">_extract_blocks</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

        <span class="n">content</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Line</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comment_txt</span><span class="p">,</span> <span class="n">line_txt</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comment_txt</span><span class="p">:</span>
                <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment_txt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">line_txt</span><span class="p">:</span>
                <span class="n">ln</span> <span class="o">=</span> <span class="n">Line</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">line_txt</span><span class="p">)</span>
                <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">LineFile</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="LineFile.read_file">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.LineFile.read_file">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LineFile&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a line file from disk.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineFile</span>
<span class="sd">            Parsed LineFile object from the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifile</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">ifile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">LineFile</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span></div>
</div>



<div class="viewcode-block" id="process_cube_routes">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.process_cube_routes">[docs]</a>
<span class="k">def</span> <span class="nf">process_cube_routes</span><span class="p">(</span>
    <span class="n">voyager_exe</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">routes_print_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">outputs_routes_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and format Cube routes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voyager_exe : Path</span>
<span class="sd">        Path to voyager executable</span>
<span class="sd">    routes_print_file: Path</span>
<span class="sd">        Path to Cube routes file</span>
<span class="sd">    outputs_routes_file: Path | None</span>
<span class="sd">        Path to output routes file. If None, will use the same path as routes_print_file.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        When Cube fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Construct the conditional part of the script</span>
    <span class="k">if</span> <span class="n">outputs_routes_file</span><span class="p">:</span>
        <span class="n">outputs_part</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;FILEO PRINTO[1] = &quot;</span><span class="si">{</span><span class="n">outputs_routes_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.CSV&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;FILEO RECO[1] = &quot;</span><span class="si">{</span><span class="n">outputs_routes_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.DBF&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="s2">&quot;      FIELDS=from_zone_id, to_zone_id, userclass, &quot;</span>
            <span class="s2">&quot;count, bundle, L, probability(6.4),&quot;</span><span class="p">,</span>
            <span class="s2">&quot;             a_node, b_node, mode, WaitA(6.2), TimeA(6.2), Actual(6.2), &quot;</span>
            <span class="s2">&quot;BXFerPen(6.2), Percvd(6.2), LegDist(6.2), TotDist(6.2)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_part</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;FILEO PRINTO[1] = &quot;</span><span class="si">{</span><span class="n">routes_print_file</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">routes_print_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">.CSV&quot;&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;FILEO RECO[1] = &quot;</span><span class="si">{</span><span class="n">routes_print_file</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">routes_print_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">.DBF&quot;&#39;</span><span class="p">,</span>
            <span class="s2">&quot;      FIELDS=from_zone_id, to_zone_id, userclass, &quot;</span>
            <span class="s2">&quot;count, bundle, L, probability(6.4),&quot;</span><span class="p">,</span>
            <span class="s2">&quot;             a_node, b_node, mode, WaitA(6.2), TimeA(6.2), Actual(6.2), &quot;</span>
            <span class="s2">&quot;BXFerPen(6.2), Percvd(6.2), LegDist(6.2), TotDist(6.2)&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># Combine the conditional part with the rest of the script</span>
    <span class="n">script_text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;RUN PGM=MATRIX PRNFILE=&quot;</span><span class="si">{</span><span class="n">routes_print_file</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="se">\\</span><span class="s1">ParseRoutes_</span><span class="si">{</span><span class="n">routes_print_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">.PRN&quot;&#39;</span><span class="p">,</span>
            <span class="s2">&quot;; Outputs&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="o">+</span> <span class="n">outputs_part</span>
        <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;; Inputs&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;FILEI RECI = &quot;</span><span class="si">{</span><span class="n">routes_print_file</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;; Process&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MAXSTRINGS=1000&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ARRAY TYPE=C999 _LINE_LIST=100&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ARRAY _NODE_LIST=100 _MODE_LIST=100 _WAITA_LIST=100 _TimeA_LIST=100 _Actual_LIST=100&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ARRAY _BXferPen_LIST=100 _Percvd_LIST=100 _Dist_LIST=100 _Total_LIST=100&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IF(Reci.RecNo=1)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;  PRINT  PRINTO=1, CSV=T, LIST=&#39;from_stn_zone_id&#39;, &#39;to_stn_zone_id&#39;, &quot;</span>
            <span class="s2">&quot;&#39;bundle&#39;, &#39;L&#39;, &#39;probability&#39;, &#39;a_node&#39;, &#39;b_node&#39;,&quot;</span><span class="p">,</span>
            <span class="s2">&quot;                               &#39;mode&#39;, &#39;WaitActual&#39;, &#39;TimeActual&#39;, &quot;</span>
            <span class="s2">&quot;&#39;TotalActual&#39;, &#39;BrdXFerPen&#39;, &#39;PercvdTime&#39;, &#39;LegDistance&#39;, &#39;TotDistance&#39;, &#39;Services&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ENDIF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IF (STRPOS(&#39;User&#39;,RECI)=1)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _UserClass = _UserClass + 1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    IF(_UserClass &gt; 1) &quot;</span><span class="p">,</span>
            <span class="s2">&quot;      _UserClass = 1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    ENDIF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ENDIF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IF (STRPOS(&#39;N:&#39;,RECI)=1)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _COUNTN=1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _NODE_LIST[_COUNTN]=VAL(TRIM(LTRIM(SUBSTR(RECI,3, STRPOS(&#39;Mode&#39;,RECI)-3)))) &quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _ROUTEBUNDLE=_ROUTEBUNDLE+1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ENDIF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IF (STRPOS(&#39;-&gt;&#39;,RECI)=1) &quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _COUNTN=_COUNTN+1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _NODE_LIST[_COUNTN]=VAL(SUBSTR(RECI,3,6)) &quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _MODE_LIST[_COUNTN]=VAL(SUBSTR(RECI,9,5)) &quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _WAITA_LIST[_COUNTN]=VAL(SUBSTR(RECI,14,7))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _TimeA_LIST[_COUNTN]=VAL(SUBSTR(RECI,21,7))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _Actual_LIST[_COUNTN]=VAL(SUBSTR(RECI,28,7))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _BXferPen_LIST[_COUNTN]=VAL(SUBSTR(RECI,35,7))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _Percvd_LIST[_COUNTN]=VAL(SUBSTR(RECI,42,7))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _Dist_LIST[_COUNTN]=VAL(SUBSTR(RECI,49,7))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _Total_LIST[_COUNTN]=VAL(SUBSTR(RECI,56,7))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _LINE_LIST[_COUNTN]=LTRIM(SUBSTR(RECI,65,800))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ENDIF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IF (STRPOS(&#39;Probability=&#39;, RECI)=1)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _ProbTemp = VAL(SUBSTR(RECI,13,800))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    IF(_ProbTemp&gt;0) &quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;      RO.probability=VAL(SUBSTR(RECI,13,800))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;      LOOP L=1,_COUNTN-1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.from_stn_zone_id=_NODE_LIST[1]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.to_stn_zone_id=_NODE_LIST[_COUNTN]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.userclass = _UserClass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.count = _COUNTN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.bundle=_ROUTEBUNDLE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.a_node=_NODE_LIST[L] &quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.b_node=_NODE_LIST[L+1] &quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.mode=_MODE_LIST[L+1]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.WAITA=_WAITA_LIST[L+1]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.TimeA=_TimeA_LIST[L+1]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.Actual=_Actual_LIST[L+1]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.BXferPen=_BXferPen_LIST[L+1]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.Percvd=_Percvd_LIST[L+1]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.LegDist=_Dist_LIST[L+1]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          RO.TotDist=_Total_LIST[L+1]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          WRITE RECO=1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;          PRINT CSV=T, LIST=RO.from_stn_zone_id(5.0L), RO.to_stn_zone_id(5.0L), &quot;</span>
            <span class="s2">&quot;RO.bundle(5.0L), L(5.0), RO.probability(6.4L), RO.a_node(6.0L), RO.b_node(6.0L),&quot;</span><span class="p">,</span>
            <span class="s2">&quot;                          RO.mode(3.0L), RO.WaitA(12.2L), RO.TimeA(12.2L), &quot;</span>
            <span class="s2">&quot;RO.Actual(12.2L), RO.BXferPen(12.2L), RO.Percvd(12.2L), RO.LegDist(12.2L), RO.TotDist(12.2L), &quot;</span><span class="p">,</span>
            <span class="s2">&quot;                          _LINE_LIST[L+1](L999) PRINTO=1 &quot;</span><span class="p">,</span>
            <span class="s2">&quot;      ENDLOOP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    ENDIF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _COUNTN=0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ENDIF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IF (STRPOS(&#39;REval Route(s)&#39;, RECI)&gt;0)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    _ROUTEBUNDLE=0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ENDIF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ENDRUN&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">script_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="n">routes_print_file</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;ParseRoutes_</span><span class="si">{</span><span class="n">routes_print_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.S&quot;</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_text</span><span class="p">))</span>

    <span class="c1"># Run CUBE</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">voyager_exe</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="n">script_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="s2">&quot;-Pvdmi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Hide&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/HideScript&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">process_results</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">process_results</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot; ERROR: Check -&gt; </span><span class="si">{</span><span class="n">routes_print_file</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">/ParseRoutes_</span><span class="si">{</span><span class="n">routes_print_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.PRN&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>

    <span class="c1"># Cleanup files</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="s2">&quot;TPPL.PRJ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">del_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(vdmi.*)\.(prn|var)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">script_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">del_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>



<div class="viewcode-block" id="network_to_shapefile">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.network_to_shapefile">[docs]</a>
<span class="k">def</span> <span class="nf">network_to_shapefile</span><span class="p">(</span>
    <span class="n">voyager_exe</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">network_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">nodes_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">links_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">projection_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Export Cube network to Links and Nodes shapefiles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voyager_exe : Path</span>
<span class="sd">        Path to voyager executable</span>
<span class="sd">    network_file: Path</span>
<span class="sd">        Path to run folder</span>
<span class="sd">    nodes_file: Path</span>
<span class="sd">        Path to nodes shapefile</span>
<span class="sd">    links_file: Path</span>
<span class="sd">        Path to links shapefile</span>
<span class="sd">    projection_string: Optional[str]</span>
<span class="sd">        projection string to use for shapefiles</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        When Cube fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nodes_file</span><span class="p">:</span>
        <span class="n">nodes_file_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nodes_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">.SHP&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nodes_file_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">_Nodes.SHP&quot;</span>
    <span class="k">if</span> <span class="n">links_file</span><span class="p">:</span>
        <span class="n">links_file_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">links_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">.SHP&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">links_file_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">_Links.SHP&quot;</span>
    <span class="n">script_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;RUN PGM=NETWORK PRNFILE=&quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="se">\\</span><span class="s1">ConvertNetwork.TPRN&quot;&#39;</span><span class="p">,</span>
        <span class="s2">&quot;; Outputs&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;FILEO NODEO = &quot;</span><span class="si">{</span><span class="n">nodes_file_str</span><span class="si">}</span><span class="s1">&quot;,&#39;</span><span class="p">,</span>
        <span class="s2">&quot;     FORMAT=SHP&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;FILEO NODEO = &quot;</span><span class="si">{</span><span class="n">links_file_str</span><span class="si">}</span><span class="s1">&quot;,&#39;</span><span class="p">,</span>
        <span class="s2">&quot;     FORMAT=SHP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;; Inputs&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;FILEI LINKI[1] = &quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
        <span class="s2">&quot;; Process&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PROCESS PHASE = NODEMERGE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;   GEOMETRYSOURCE=1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ENDPROCESS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PROCESS PHASE = LINKMERGE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;   GEOMETRYSOURCE=1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ENDPROCESS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ENDRUN&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">script_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">network_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;ConvertNetwork.S&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_text</span><span class="p">))</span>

    <span class="c1"># Run CUBE</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">voyager_exe</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="n">script_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="s2">&quot;-Pvdmi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Hide&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/HideScript&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">process_results</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">process_results</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: Failed to convert </span><span class="si">{</span><span class="n">network_file</span><span class="si">}</span><span class="s2"> to shapefiles&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>

    <span class="c1"># Write projections</span>
    <span class="k">if</span> <span class="n">projection_string</span><span class="p">:</span>
        <span class="n">projection_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">_Nodes.PRJ&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">projection_file_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">proj_file</span><span class="p">:</span>
            <span class="n">proj_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">projection_string</span><span class="p">)</span>
        <span class="n">projection_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">_Links.PRJ&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">projection_file_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">proj_file</span><span class="p">:</span>
            <span class="n">proj_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">projection_string</span><span class="p">)</span>
    <span class="c1"># Cleanup files</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="s2">&quot;TPPL.PRJ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">del_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(vdmi.*)\.(tprn|var)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">script_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">del_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>



<div class="viewcode-block" id="export_network_to_csvs">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.export_network_to_csvs">[docs]</a>
<span class="k">def</span> <span class="nf">export_network_to_csvs</span><span class="p">(</span>
    <span class="n">voyager_exe</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">network_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">nodes_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">links_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Export Cube network to Links and Nodes CSVs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voyager_exe : Path</span>
<span class="sd">        Path to voyager executable</span>
<span class="sd">    network_file: Path</span>
<span class="sd">        Path to run folder</span>
<span class="sd">    nodes_file: Path</span>
<span class="sd">        Path to nodes CSV</span>
<span class="sd">    links_file: Path</span>
<span class="sd">        Path to links CSV</span>


<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        When Cube fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nodes_file</span><span class="p">:</span>
        <span class="n">nodes_file_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nodes_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">.CSV&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nodes_file_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">_Nodes.CSV&quot;</span>
    <span class="k">if</span> <span class="n">links_file</span><span class="p">:</span>
        <span class="n">links_file_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">links_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">.CSV&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">links_file_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">_Links.CSV&quot;</span>
    <span class="n">script_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;RUN PGM=NETWORK PRNFILE=&quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="se">\\</span><span class="s1">ConvertNetwork.TPRN&quot;&#39;</span><span class="p">,</span>
        <span class="s2">&quot;; Outputs&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;FILEO NODEO = &quot;</span><span class="si">{</span><span class="n">nodes_file_str</span><span class="si">}</span><span class="s1">&quot;,&#39;</span><span class="p">,</span>
        <span class="s1">&#39;     FORMAT=TXT, DELIMITER=&quot;,&quot;&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;FILEO LINKO = &quot;</span><span class="si">{</span><span class="n">links_file_str</span><span class="si">}</span><span class="s1">&quot;,&#39;</span><span class="p">,</span>
        <span class="s1">&#39;     FORMAT=TXT, DELIMITER=&quot;,&quot;&#39;</span><span class="p">,</span>
        <span class="s2">&quot;; Inputs&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;FILEI LINKI[1] = &quot;</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
        <span class="s2">&quot;; Process&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ENDRUN&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">script_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="n">network_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;ConvertNetwork_</span><span class="si">{</span><span class="n">network_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.S&quot;</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_text</span><span class="p">))</span>

    <span class="c1"># Run CUBE</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">voyager_exe</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="n">script_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="s2">&quot;-Pvdmi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Hide&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/HideScript&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">process_results</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">process_results</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: Failed to convert </span><span class="si">{</span><span class="n">network_file</span><span class="si">}</span><span class="s2"> to CSVs&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>

    <span class="c1"># Cleanup files</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="s2">&quot;TPPL.PRJ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">del_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(vdmi.*)\.(tprn|var)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">script_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">del_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>



<div class="viewcode-block" id="build_network_from_csvs">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.build_network_from_csvs">[docs]</a>
<span class="k">def</span> <span class="nf">build_network_from_csvs</span><span class="p">(</span>
    <span class="n">voyager_exe</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">links_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">nodes_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">network_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">links_var</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">nodes_var</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build Cube network from links and nodes CSVs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voyager_exe : Path</span>
<span class="sd">        Path to voyager executable</span>
<span class="sd">    links_file: Path</span>
<span class="sd">        Path to links CSV</span>
<span class="sd">    nodes_file: Path</span>
<span class="sd">        Path to nodes CSV</span>
<span class="sd">    network_path: Path</span>
<span class="sd">        Path to network folder</span>
<span class="sd">    links_var: list[str]</span>
<span class="sd">        List of Links csv variables, must include &quot;A&quot; and &quot;B&quot;</span>
<span class="sd">    nodes_var: list[str]</span>
<span class="sd">        List of Nodes csv variables, must include &quot;N&quot;, &quot;X&quot; and &quot;Y&quot;</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        When Cube fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">script_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;RUN PGM=NETWORK PRNFILE=&quot;</span><span class="si">{</span><span class="n">network_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="se">\\</span><span class="s1">CreateNetwork_</span><span class="si">{</span><span class="n">network_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">.TPRN&quot;&#39;</span><span class="p">,</span>
        <span class="s2">&quot;; Outputs&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;FILEO NETO = &quot;</span><span class="si">{</span><span class="n">network_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.NET&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
        <span class="s2">&quot;; Inputs&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;FILEI LINKI[1] = &quot;</span><span class="si">{</span><span class="n">links_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.CSV&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;      VAR=</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">links_var</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;FILEI NODEI[1] = &quot;</span><span class="si">{</span><span class="n">nodes_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.CSV&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;      VAR=</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">nodes_var</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s2">&quot;; Process&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ENDRUN&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">script_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="n">network_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;CreateNetwork_</span><span class="si">{</span><span class="n">network_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.S&quot;</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_text</span><span class="p">))</span>

    <span class="c1"># Run CUBE</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">voyager_exe</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="n">script_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="s2">&quot;-Pvdmi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Hide&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/HideScript&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">process_results</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">process_results</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: Failed to Build Network from </span><span class="si">{</span><span class="n">links_file</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">nodes_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>

    <span class="c1"># Cleanup files</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="s2">&quot;TPPL.PRJ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">del_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(vdmi.*)\.(tprn|var)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">script_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">del_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>



<div class="viewcode-block" id="omx_to_mat">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.omx_to_mat">[docs]</a>
<span class="k">def</span> <span class="nf">omx_to_mat</span><span class="p">(</span>
    <span class="n">voyager_exe</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">omx_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">mat_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert OMX Matrix to Cube MAT matrix</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voyager_exe : Path</span>
<span class="sd">        Path to voyager executable</span>
<span class="sd">    omx_path : Path</span>
<span class="sd">        Path to OMX matrix file</span>
<span class="sd">    mat_path: Path</span>
<span class="sd">        Path to Cube MAT matrix</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        When Cube fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">script_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;CONVERTMAT FROM=&quot;</span><span class="si">{</span><span class="n">omx_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.OMX&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot; TO=&quot;</span><span class="si">{</span><span class="n">mat_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.MAT&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot; FORMAT=TPP COMPRESSION=0&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">script_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mat_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Convert_OMX2MAT_</span><span class="si">{</span><span class="n">omx_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.S&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_text</span><span class="p">))</span>

    <span class="c1"># Run CUBE</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">voyager_exe</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="n">script_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="s2">&quot;-Pvdmi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Hide&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/HideScript&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">process_results</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">process_results</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: Failed to Convert </span><span class="si">{</span><span class="n">omx_path</span><span class="si">}</span><span class="s2"> to Cube .MAT&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>

    <span class="c1"># Cleanup files</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="s2">&quot;TPPL.PRJ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">del_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(vdmi.*)\.(prn|var)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">script_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">del_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>



<div class="viewcode-block" id="mat_to_omx">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.mat_to_omx">[docs]</a>
<span class="k">def</span> <span class="nf">mat_to_omx</span><span class="p">(</span>
    <span class="n">voyager_exe</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">mat_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">omx_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">compression</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert Cube .MAT to OMX Matrix</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    voyager_exe : Path</span>
<span class="sd">        Path to voyager executable</span>
<span class="sd">    mat_path: Path</span>
<span class="sd">        Path to Cube MAT matrix</span>
<span class="sd">    omx_path : Path</span>
<span class="sd">        Path to OMX matrix file</span>
<span class="sd">    compression: int, default 0</span>
<span class="sd">        Compression level of output matrix</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        When Cube fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">script_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;CONVERTMAT FROM=&quot;</span><span class="si">{</span><span class="n">mat_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.MAT&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot; TO=&quot;</span><span class="si">{</span><span class="n">omx_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.OMX&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot; FORMAT=OMX COMPRESSION=</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">script_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">omx_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Convert_MAT2OMX_</span><span class="si">{</span><span class="n">mat_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.S&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_text</span><span class="p">))</span>

    <span class="c1"># Run CUBE</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">voyager_exe</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="n">script_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="s2">&quot;-Pvdmi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/Hide&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/HideScript&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">process_results</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">process_results</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: Failed to Convert </span><span class="si">{</span><span class="n">mat_path</span><span class="si">}</span><span class="s2"> to OMX&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>

    <span class="c1"># Cleanup files</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">script_path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="s2">&quot;TPPL.PRJ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">del_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(vdmi.*)\.(prn|var)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">script_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">del_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>



<div class="viewcode-block" id="parse_cube_zones_character">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.parse_cube_zones_character">[docs]</a>
<span class="k">def</span> <span class="nf">parse_cube_zones_character</span><span class="p">(</span>
    <span class="n">cube_range</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse Cube format list of zones/ranges into list of zones</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cube_range : str</span>
<span class="sd">        range of Cube style list/range of zones</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    zones_list : list[Any]</span>
<span class="sd">        list of individual zones</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># remove white space</span>
    <span class="n">cube_range</span> <span class="o">=</span> <span class="n">cube_range</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">zones</span> <span class="o">=</span> <span class="n">cube_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">zones_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">zone</span><span class="p">:</span>
            <span class="c1"># split range</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">zone</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
            <span class="c1"># create inclusive range</span>
            <span class="n">zones_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">zones_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">zones_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zone</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">zones_list</span></div>



<div class="viewcode-block" id="parse_sqex_file">
<a class="viewcode-back" href="../../../api/cube.html#sysame.cube.cube.parse_sqex_file">[docs]</a>
<span class="k">def</span> <span class="nf">parse_sqex_file</span><span class="p">(</span>
    <span class="n">sqex_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sectors</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read Cube&#39;s SQEX file and create a lookup dataframe between zones and sectors.</span>

<span class="sd">    NOTE: The function currently assumes a full weighting zones&lt;&gt;sectors.</span>
<span class="sd">    i.e. if a zone is split weighted across multiple sectors then the function will</span>
<span class="sd">    ignore that and take first appearance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sqex_file : Path</span>
<span class="sd">        path to the sqex file</span>
<span class="sd">    level : str</span>
<span class="sd">        the zone level either &quot;stn&quot; or &quot;zone&quot;</span>
<span class="sd">    sectors : str</span>
<span class="sd">        number of sectors</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sqex_df : pl.DataFrame</span>
<span class="sd">        stn/zone to sectors lookup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read sqex file into a dataframe</span>
    <span class="n">sqex_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">sqex_file</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">_zone_id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Sectors_</span><span class="si">{</span><span class="n">sectors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="n">dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Int32</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int32</span><span class="p">],</span>
    <span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="c1"># drop duplicates to remove split weights</span>
    <span class="n">sqex_df</span> <span class="o">=</span> <span class="n">sqex_df</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">sqex_df</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, sysame.com.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>