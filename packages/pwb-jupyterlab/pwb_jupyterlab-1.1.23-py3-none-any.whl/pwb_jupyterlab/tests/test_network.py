import os

import pwb_jupyterlab.network as network

def replace_uid(tcp):
    curr_uid = os.geteuid()
    tcp = tcp.replace("<uid>", str(curr_uid))
    return tcp

async def test_parse_tcp_info():
    tcp4  = replace_uid("  sl  local_address rem_address   st tx_queue rx_queue tr tm->when retrnsmt   uid  timeout inode                                                     \n    0: 4701A8C0:1AA1 00000000:0000 0A 00000000:00000000 00:00000000 00000000   899        0 26205 1 0000000000000000 100 0 0 10 0                     \n    1: 00000000:1AA2 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 32188 1 0000000000000000 100 0 0 10 0                     \n    2: 00000000:1AA3 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 35013 1 0000000000000000 100 0 0 10 0                     \n    3: 00000000:1AA4 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 35016 1 0000000000000000 100 0 0 10 0                     \n    4: 0100007F:0DE7 00000000:0000 0A 00000000:00000000 00:00000000 00000000  <uid>        0 142188 1 0000000000000000 100 0 0 10 0                    \n    5: 0100007F:6989 00000000:0000 0A 00000000:00000000 00:00000000 00000000   124        0 30630 1 0000000000000000 100 0 0 10 0                     \n    6: 00000000:006F 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 26744 1 0000000000000000 100 0 0 10 0                     \n    7: 00000000:0050 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 38183 1 0000000000000000 100 0 0 10 0                     \n    8: 3500007F:0035 00000000:0000 0A 00000000:00000000 00:00000000 00000000   101        0 27737 1 0000000000000000 100 0 0 10 0                     \n    9: 4701A8C0:15B7 00000000:0000 0A 00000000:00000000 00:00000000 00000000   998        0 39683 1 0000000000000000 100 0 0 10 0                     \n   11: 4701A8C0:1AA1 4701A8C0:E186 06 00000000:00000000 03:00000DB4 00000000     0        0 0 3 0000000000000000                                      \n   12: 4701A8C0:1AA1 4701A8C0:E19E 06 00000000:00000000 03:0000139A 00000000     0        0 0 3 0000000000000000                                      \n   13: 4701A8C0:1AA1 4701A8C0:E18E 06 00000000:00000000 03:00000FAC 00000000     0        0 0 3 0000000000000000                                      \n   14: 4701A8C0:B2BC 0670528C:01BB 06 00000000:00000000 03:00000EBC 00000000     0        0 0 3 0000000000000000                                      \n   15: 4701A8C0:1AA1 4701A8C0:E17C 06 00000000:00000000 03:00000BBA 00000000     0        0 0 3 0000000000000000                                      \n   16: 4701A8C0:840A E657D636:01BB 01 00000000:00000000 02:00000DE4 00000000  <uid>        0 349856 2 0000000000000000 22 4 26 10 -1                   \n   17: 4701A8C0:E92C 4C70CB36:01BB 01 00000000:00000000 02:000000A7 00000000  <uid>        0 351608 2 0000000000000000 22 4 0 10 -1                    \n   18: 4701A8C0:E7B8 AC29A236:01BB 01 00000000:00000000 02:00000048 00000000  <uid>        0 334892 2 0000000000000000 28 4 30 10 -1                   \n   19: 4701A8C0:1AA1 4701A8C0:E1A8 06 00000000:00000000 03:00001592 00000000     0        0 0 3 0000000000000000                                      \n   20: 4701A8C0:AA74 DBE1D612:01BB 01 00000000:00000000 02:0000003E 00000000  <uid>        0 339211 2 0000000000000000 28 4 26 10 -1                   \n   21: 4701A8C0:1AA1 4701A8C0:E162 06 00000000:00000000 03:000005D4 00000000     0        0 0 3 0000000000000000                                      \n   22: 4701A8C0:98FC B25E9536:01BB 01 00000000:00000000 02:00000EDD 00000000  <uid>        0 99285 2 0000000000000000 22 4 30 10 -1                    \n   23: 4701A8C0:900C 856FC7B9:01BB 01 00000000:00000000 02:00000EE4 00000000  <uid>        0 328405 2 0000000000000000 21 4 17 14 -1                   \n   24: 4701A8C0:1AA1 4701A8C0:E18C 06 00000000:00000000 03:00000FAB 00000000     0        0 0 3 0000000000000000                                      \n   25: 4701A8C0:1AA1 4701A8C0:E172 06 00000000:00000000 03:000009C2 00000000     0        0 0 3 0000000000000000                                      \n   26: 4701A8C0:E8B8 4C70CB36:01BB 06 00000000:00000000 03:0000062E 00000000     0        0 0 3 0000000000000000                                      \n   27: 4701A8C0:1AA1 4701A8C0:E174 06 00000000:00000000 03:000009C2 00000000     0        0 0 3 0000000000000000                                      \n   28: 4701A8C0:1AA1 4701A8C0:E15A 06 00000000:00000000 03:000003DE 00000000     0        0 0 3 0000000000000000                                      \n   29: 4701A8C0:1AA1 4701A8C0:E146 06 00000000:00000000 03:00000000 00000000     0        0 0 3 0000000000000000                                      \n   30: 4701A8C0:E83A 4C70CB36:01BB 01 00000000:00000000 02:00000FB2 00000000  <uid>        0 349675 2 0000000000000000 22 4 28 10 -1                   \n   31: 4701A8C0:1AA1 4701A8C0:E160 06 00000000:00000000 03:000005D4 00000000     0        0 0 3 0000000000000000                                      \n   32: 4701A8C0:A5CC 17430841:01BB 01 00000000:00000000 02:000003B1 00000000  <uid>        0 351282 2 0000000000000000 20 4 8 10 -1                    \n   33: 4701A8C0:C70E 71265936:01BB 01 00000000:00000000 02:00001131 00000000  <uid>        0 108408 2 0000000000000000 30 4 26 10 -1                   \n   34: 4701A8C0:EC88 1A72528C:01BB 01 00000000:00000000 02:00000250 00000000  <uid>        0 333154 2 0000000000000000 28 4 31 10 -1                   \n   35: 4701A8C0:840C E657D636:01BB 01 00000000:00000000 02:00000E4A 00000000  <uid>        0 349857 2 0000000000000000 21 4 26 10 -1                   \n   36: 4701A8C0:1AA1 4701A8C0:E16A 06 00000000:00000000 03:000007CC 00000000     0        0 0 3 0000000000000000                                      \n   37: 4701A8C0:1AA1 4701A8C0:E194 06 00000000:00000000 03:000011A2 00000000     0        0 0 3 0000000000000000                                      \n   38: 4701A8C0:ED46 71461268:01BB 01 00000000:00000000 02:00000D4B 00000000  <uid>        0 331525 2 0000000000000000 20 4 10 10 -1                   \n   39: 4701A8C0:1AA1 4701A8C0:E148 06 00000000:00000000 03:00000000 00000000     0        0 0 3 0000000000000000                                      \n   40: 4701A8C0:1AA1 4701A8C0:E17E 06 00000000:00000000 03:00000BBA 00000000     0        0 0 3 0000000000000000                                      \n   41: 4701A8C0:1AA1 4701A8C0:E150 06 00000000:00000000 03:000001E8 00000000     0        0 0 3 0000000000000000                                      \n   42: 4701A8C0:1AA1 4701A8C0:E16C 06 00000000:00000000 03:000007CC 00000000     0        0 0 3 0000000000000000                                      \n   43: 4701A8C0:92D6 87BF9536:01BB 01 00000000:00000000 02:00000E17 00000000  <uid>        0 329725 2 0000000000000000 22 4 21 10 -1                   \n   44: 4701A8C0:1AA1 4701A8C0:E196 06 00000000:00000000 03:000011A2 00000000     0        0 0 3 0000000000000000                                      \n   45: 4701A8C0:1AA1 4701A8C0:E158 06 00000000:00000000 03:000003DE 00000000     0        0 0 3 0000000000000000                                      \n   46: 4701A8C0:1AA1 4701A8C0:E184 06 00000000:00000000 03:00000DB3 00000000     0        0 0 3 0000000000000000                                      \n   47: 4701A8C0:990E B25E9536:01BB 01 00000000:00000000 02:0000031E 00000000  <uid>        0 101593 2 0000000000000000 22 4 30 10 -1                   \n   48: 4701A8C0:1AA1 4701A8C0:E1A0 06 00000000:00000000 03:0000139A 00000000     0        0 0 3 0000000000000000                                      \n   49: 4701A8C0:1AA1 4701A8C0:E1A6 06 00000000:00000000 03:00001592 00000000     0        0 0 3 0000000000000000                                      \n   50: 4701A8C0:1AA1 4701A8C0:E14E 06 00000000:00000000 03:000001E8 00000000     0        0 0 3 0000000000000000")
    tcp6 = replace_uid("  sl  local_address                         remote_address                        st tx_queue rx_queue tr tm->when retrnsmt   uid  timeout inode\n    0: 00000000000000000000000000000000:97B9 00000000000000000000000000000000:0000 0A 00000000:00000000 00:00000000 00000000  <uid>        0 458231 1 0000000000000000 100 0 0 10 0\n    1: 6905012000BB537CC825B29C909C056B:9DDB 00000000000000000000000000000000:0000 0A 00000000:00000000 00:00000000 00000000  <uid>        0 338946 1 0000000000000000 100 0 0 10 0\n    2: 00000000000000000000000000000000:88DD 00000000000000000000000000000000:0000 0A 00000000:00000000 00:00000000 00000000  <uid>        0 470097 1 0000000000000000 100 0 0 10 0\n   25: 00000000000000000000000001000000:0277 00000000000000000000000000000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 27312 1 0000000000000000 100 0 0 10 0\n   26: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF8E 06 00000000:00000000 03:00001412 00000000     0        0 0 3 0000000000000000\n   27: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF74 06 00000000:00000000 03:00000E35 00000000     0        0 0 3 0000000000000000\n   28: 0000000000000000FFFF00000100007F:9B0F 0000000000000000FFFF00000100007F:80F2 01 00000000:00000000 00:00000000 00000000  <uid>        0 551550 1 0000000000000000 20 5 7 10 -1\n   29: 6905012000BB537CC825B29C909C056B:E24E 01190026B69400000000000000000000:01BB 01 00000000:00000000 02:0000083F 00000000  <uid>        0 505114 2 0000000000000000 20 4 1 10 -1\n   30: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF62 06 00000000:00000000 03:00000A4D 00000000     0        0 0 3 0000000000000000\n   31: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF96 06 00000000:00000000 03:00001606 00000000     0        0 0 3 0000000000000000\n   32: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF52 06 00000000:00000000 03:00000664 00000000     0        0 0 3 0000000000000000\n   33: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF4A 06 00000000:00000000 03:0000046F 00000000     0        0 0 3 0000000000000000\n   34: 6905012000BB537CC825B29C909C056B:DF84 6905012000BB537CC825B29C909C056B:0CEA 06 00000000:00000000 03:0000121D 00000000     0        0 0 3 0000000000000000\n   35: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF7C 06 00000000:00000000 03:00001029 00000000     0        0 0 3 0000000000000000\n   36: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF32 06 00000000:00000000 03:00000087 00000000     0        0 0 3 0000000000000000\n   37: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF84 06 00000000:00000000 03:0000121D 00000000     0        0 0 3 0000000000000000\n   38: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF6C 06 00000000:00000000 03:00000C40 00000000     0        0 0 3 0000000000000000\n   39: 6905012000BB537CC825B29C909C056B:C0B4 87FA042A0000FEFF00000000024900C0:01BB 06 00000000:00000000 03:00000F95 00000000     0        0 0 3 0000000000000000\n   40: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF5A 06 00000000:00000000 03:00000858 00000000     0        0 0 3 0000000000000000\n   41: 0000000000000000FFFF00000100007F:AA77 0000000000000000FFFF00000100007F:B2B8 01 00000000:00000000 00:00000000 00000000  <uid>        0 548738 1 0000000000000000 20 4 1 10 -1\n   42: 6905012000BB537CC825B29C909C056B:8600 424E042A00000D000000000049060000:01BB 01 00000000:00000000 02:000000F6 00000000  <uid>        0 555980 2 0000000000000000 21 4 8 10 -1\n   43: 6905012000BB537CC825B29C909C056B:E5B2 B0F8072601080A400000000005200000:01BB 01 00000000:00000000 02:0000002A 00000000  <uid>        0 559811 2 0000000000000000 21 4 1 10 -1\n   44: 6905012000BB537CC825B29C909C056B:0CEA 6905012000BB537CC825B29C909C056B:DF3A 06 00000000:00000000 03:0000027B 00000000     0        0 0 3 0000000000000000")

    expected = {142188 : network.TcpInfo("127.0.0.1", "3559"),
                458231 : network.TcpInfo("::", "38841"),
                338946 : network.TcpInfo("2001:569:7C53:BB00:9CB2:25C8:6B05:9C90", "40411"),
                470097 : network.TcpInfo("::", "35037")}

    result = network.parse_tcp_info(tcp4, tcp6)

    assert len(result) == len(expected)

    for key, value in expected.items():
        assert key in result, f"Key {key} is missing from result {result}"
        assert value.address == expected[key].address, f"Value {expected[key].address} is not equal to value {value.address}"
        assert value.port == expected[key].port, f"Value {expected[key].port} is not equal to value {value.port}"

async def test_parse_bad_tcp_info():
    tcp4 = replace_uid("  sl  local_address rem_address   st tx_queue rx_queue tr tm->when retrnsmt   uid  timeout inode                                                     \n    0: 4701A8C0:1AA1 00000000:0000 0A 00000000:00000000 00:00000000 00000000   899        0 26205 1 0000000000000000 100 0 0 10 0                     \n    1: 00000000:1AA2 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 32188 1 0000000000000000 100 0 0 10 0                     \n    2: 00000000:1AA3 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 35013 1 0000000000000000 100 0 0 10 0                     \n    3: 00000000:1AA4 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 35016 1 0000000000000000 100 0 0 10 0                     \n    4: 0100007F:0DE7 00000000:0000 0A 00000000:00000000 00:00000000 00000000  <uid>        0 142188 1 0000000000000000 100 0 0 10 0                    \n    5: 0100007F:6989 00000000:0000 0A 00000000:00000000 00:00000000 00000000   124        0 30630 1 0000000000000000 100 0 0 10 0                     \n    6: 00000000:006F 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 26744 1 0000000000000000 100 0 0 10 0                     \n    7: 00000000:0050 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 38183 1 0000000000000000 100 0 0 10 0                     \n    8: 3500007F:0035 00000000:0000 0A 00000000:00000000 00:00000000 00000000   101        0 27737 1 0000000000000000 100 0 0 10 0                     \n    9: 4701A8C0:15B7 00000000:0000 0A 00000000:00000000 00:00000000 00000000   998        0 39683 1 0000000000000000 100 0 0 10 0                     \n   11: 4701A8C0:1AA1 4701A8C0:E186 06 00000000:00000000 03:00000DB4 00000000     0        0 0 3 0000000000000000                                      \n   12: 4701A8C0:1AA1 4701A8C0:E19E 06 00000000:00000000 03:0000139A 00000000     0        0 0 3 0000000000000000                                      \n   13: 4701A8C0:1AA1 4701A8C0:E18E 06 00000000:00000000 03:00000FAC 00000000     0        0 0 3 0000000000000000                                      \n   14: 4701A8C0:B2BC 0670528C:01BB 06 00000000:00000000 03:00000EBC 00000000     0        0 0 3 0000000000000000                                      \n   15: 4701A8C0:1AA1 4701A8C0:E17C 06 00000000:00000000 03:00000BBA 00000000     0        0 0 3 0000000000000000                                      \n   16: 4701A8C0:840A E657D636:01BB 01 00000000:00000000 02:00000DE4 00000000  <uid>        0 349856 2 0000000000000000 22 4 26 10 -1                   \n   17: 4701A8C0:E92C 4C70CB36:01BB 01 00000000:00000000 02:000000A7 00000000  <uid>        0 351608 2 0000000000000000 22 4 0 10 -1                    \n   18: 4701A8C0:E7B8 AC29A236:01BB 01 00000000:00000000 02:00000048 00000000  <uid>        0 334892 2 0000000000000000 28 4 30 10 -1                   \n   19: 4701A8C0:1AA1 4701A8C0:E1A8 06 00000000:00000000 03:00001592 00000000     0        0 0 3 0000000000000000                                      \n   20: 4701A8C0:AA74 DBE1D612:01BB 01 00000000:00000000 02:0000003E 00000000  <uid>        0 339211 2 0000000000000000 28 4 26 10 -1                   \n   21: 4701A8C0:1AA1 4701A8C0:E162 06 00000000:00000000 03:000005D4 00000000     0        0 0 3 0000000000000000                                      \n   22: 4701A8C0:98FC B25E9536:01BB 01 00000000:00000000 02:00000EDD 00000000  <uid>        0 99285 2 0000000000000000 22 4 30 10 -1                    \n   23: 4701A8C0:900C 856FC7B9:01BB 01 00000000:00000000 02:00000EE4 00000000  <uid>        0 328405 2 0000000000000000 21 4 17 14 -1                   \n   24: 4701A8C0:1AA1 4701A8C0:E18C 06 00000000:00000000 03:00000FAB 00000000     0        0 0 3 0000000000000000                                      \n   25: 4701A8C0:1AA1 4701A8C0:E172 06 00000000:00000000 03:000009C2 00000000     0        0 0 3 0000000000000000                                      \n   26: 4701A8C0:E8B8 4C70CB36:01BB 06 00000000:00000000 03:0000062E 00000000     0        0 0 3 0000000000000000                                      \n   27: 4701A8C0:1AA1 4701A8C0:E174 06 00000000:00000000 03:000009C2 00000000     0        0 0 3 0000000000000000                                      \n   28: 4701A8C0:1AA1 4701A8C0:E15A 06 00000000:00000000 03:000003DE 00000000     0        0 0 3 0000000000000000                                      \n   29: 4701A8C0:1AA1 4701A8C0:E146 06 00000000:00000000 03:00000000 00000000     0        0 0 3 0000000000000000                                      \n   30: 4701A8C0:E83A 4C70CB36:01BB 01 00000000:00000000 02:00000FB2 00000000  <uid>        0 349675 2 0000000000000000 22 4 28 10 -1                   \n   31: 4701A8C0:1AA1 4701A8C0:E160 06 00000000:00000000 03:000005D4 00000000     0        0 0 3 0000000000000000                                      \n   32: 4701A8C0:A5CC 17430841:01BB 01 00000000:00000000 02:000003B1 00000000  <uid>        0 351282 2 0000000000000000 20 4 8 10 -1                    \n   33: 4701A8C0:C70E 71265936:01BB 01 00000000:00000000 02:00001131 00000000  <uid>        0 108408 2 0000000000000000 30 4 26 10 -1                   \n   34: 4701A8C0:EC88 1A72528C:01BB 01 00000000:00000000 02:00000250 00000000  <uid>        0 333154 2 0000000000000000 28 4 31 10 -1                   \n   35: 4701A8C0:840C E657D636:01BB 01 00000000:00000000 02:00000E4A 00000000  <uid>        0 349857 2 0000000000000000 21 4 26 10 -1                   \n   36: 4701A8C0:1AA1 4701A8C0:E16A 06 00000000:00000000 03:000007CC 00000000     0        0 0 3 0000000000000000                                      \n   37: 4701A8C0:1AA1 4701A8C0:E194 06 00000000:00000000 03:000011A2 00000000     0        0 0 3 0000000000000000                                      \n   38: 4701A8C0:ED46 71461268:01BB 01 00000000:00000000 02:00000D4B 00000000  <uid>        0 331525 2 0000000000000000 20 4 10 10 -1                   \n   39: 4701A8C0:1AA1 4701A8C0:E148 06 00000000:00000000 03:00000000 00000000     0        0 0 3 0000000000000000                                      \n   40: 4701A8C0:1AA1 4701A8C0:E17E 06 00000000:00000000 03:00000BBA 00000000     0        0 0 3 0000000000000000                                      \n   41: 4701A8C0:1AA1 4701A8C0:E150 06 00000000:00000000 03:000001E8 00000000     0        0 0 3 0000000000000000                                      \n   42: 4701A8C0:1AA1 4701A8C0:E16C 06 00000000:00000000 03:000007CC 00000000     0        0 0 3 0000000000000000                                      \n   43: 4701A8C0:92D6 87BF9536:01BB 01 00000000:00000000 02:00000E17 00000000  <uid>        0 329725 2 0000000000000000 22 4 21 10 -1                   \n   44: 4701A8C0:1AA1 4701A8C0:E196 06 00000000:00000000 03:000011A2 00000000     0        0 0 3 0000000000000000                                      \n   45: 4701A8C0:1AA1 4701A8C0:E158 06 00000000:00000000 03:000003DE 00000000     0        0 0 3 0000000000000000                                      \n   46: 4701A8C0:1AA1 4701A8C0:E184 06 00000000:00000000 03:00000DB3 00000000     0        0 0 3 0000000000000000                                      \n   47: 4701A8C0:990E B25E9536:01BB 01 00000000:00000000 02:0000031E 00000000  <uid>        0 101593 2 0000000000000000 22 4 30 10 -1                   \n   48: 4701A8C0:1AA1 4701A8C0:E1A0 06 00000000:00000000 03:0000139A 00000000     0        0 0 3 0000000000000000                                      \n   49: 4701A8C0:1AA1 4701A8C0:E1A6 06 00000000:00000000 03:00001592 00000000     0        0 0 3 0000000000000000                                      \n   50: 4701A8C0:1AA1 4701A8C0:E14E 06 00000000:00000000 03:000001E8 00000000     0        0 0 3 0000000000000000")
    tcp6 = " first line\n bad line"

    expected = { 142188 : network.TcpInfo("127.0.0.1", "3559") }
    result = network.parse_tcp_info(tcp4, tcp6)

    assert len(result) == len(expected)
    for key, value in expected.items():
        assert key in result, f"Key {key} is missing from result {result}"
        assert value.address == expected[key].address, f"Value {expected[key].address} is not equal to value {value.address}"
        assert value.port == expected[key].port, f"Value {expected[key].port} is not equal to value {value.port}"

async def test_empty_tcp_file():
    tcp4 = ""
    tcp6 = ""

    result = network.parse_tcp_info(tcp4, tcp6)
    assert len(result) == 0