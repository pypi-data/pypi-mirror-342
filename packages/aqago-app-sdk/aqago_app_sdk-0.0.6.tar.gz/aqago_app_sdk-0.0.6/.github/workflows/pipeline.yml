# spell:ignore taiki 

name: CI Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - dev
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Just
        uses: taiki-e/install-action@just
      - name: Install Development Tools
        run: just install
      - name: Run Checks
        run: just check
  test:
    name: Test
    needs: check
    runs-on: ubuntu-latest 
    strategy:
      matrix:
        python-version:
          - "3.11"
          - "3.12"
    env: 
      UV_PYTHON: ${{ matrix.python-version }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Just
        uses: taiki-e/install-action@just
      - name: Install Development Tools
        run: just install
      - name: Run Tests
        run: just test
  build:
    name: Build
    runs-on: ubuntu-latest 
    needs: test
    environment: ${{ github.ref_name == 'dev' && 'dev' || 'main' }}
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true
          fetch-depth: 0
      - name: Install Just
        uses: taiki-e/install-action@just
      - name: Install Development Tools
        run: just install
      - name: Run Build
        run: just build 
      - name: Publish
        run: just publish ${{ vars.PYPI_INDEX }}